<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nelavista Smart Classroom</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 10px;
            gap: 10px;
        }

        /* Main Stage - Teacher Video */
        .main-stage {
            flex: 3;
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .stage-header {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .live-badge {
            background: #ff4757;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        .live-badge.active {
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .student-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        #teacherVideo {
            flex: 1;
            width: 100%;
            object-fit: contain;
            background: #000;
        }

        .no-stream {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 18px;
            background: #000;
        }

        /* Sidebar */
        .sidebar {
            flex: 1;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 15px;
            background: #2c3e50;
            color: white;
        }

        .tabs {
            display: flex;
            background: #34495e;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: #2c3e50;
            color: white;
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Questions Tab */
        .question-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .question-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .question-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .question-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d35400;
        }

        /* Raised Hands Tab */
        .hand-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .hand-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hand-info {
            flex: 1;
        }

        .hand-username {
            font-weight: 600;
            color: #856404;
        }

        .hand-time {
            font-size: 11px;
            color: #d39e00;
            margin-top: 2px;
        }

        .hand-actions {
            display: flex;
            gap: 8px;
        }

        /* Participants Tab */
        .participant-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .participant-role {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .role-teacher {
            background: #3498db;
            color: white;
        }

        .role-student {
            background: #95a5a6;
            color: white;
        }

        .role-speaking {
            background: #2ecc71;
            color: white;
        }

        /* Input Area */
        .input-area {
            border-top: 1px solid #eee;
            padding: 15px;
            background: white;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Controls */
        .controls {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        /* Student Specific */
        .student-controls {
            text-align: center;
        }

        .raise-hand-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px auto;
            transition: all 0.3s;
        }

        .raise-hand-btn:hover:not(:disabled) {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        .raise-hand-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .help-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 10px auto;
        }

        /* Teacher Specific */
        .teacher-preview {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 120px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid #3498db;
            display: none;
        }

        #teacherPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .broadcast-active .teacher-preview {
            display: block;
        }

        /* Active Speaker Area */
        .active-speaker {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 15px;
            color: white;
            max-width: 300px;
            display: none;
        }

        .active-speaker.active {
            display: block;
        }

        .speaker-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .speaker-video {
            width: 100px;
            height: 75px;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }

        #studentSpeakerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Status Messages */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .status-success {
            border-left: 4px solid #2ecc71;
        }

        .status-info {
            border-left: 4px solid #3498db;
        }

        .status-warning {
            border-left: 4px solid #f39c12;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                max-width: none;
                max-height: 40vh;
            }
            
            .teacher-preview {
                width: 120px;
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Stage -->
        <div class="main-stage" id="mainStage">
            <div class="stage-header">
                <div class="room-info">
                    <h2 id="roomTitle">Room: Loading...</h2>
                    <div class="live-badge" id="liveBadge">‚óè LIVE</div>
                    <div class="student-count">üë• <span id="studentCount">0</span> students</div>
                </div>
                <div id="connectionStatus">Connecting...</div>
            </div>
            
            <!-- Teacher Video Stream -->
            <video id="teacherVideo" autoplay playsinline></video>
            <div id="noStream" class="no-stream">
                Waiting for teacher to start broadcast...
            </div>
            
            <!-- Teacher Local Preview (Teacher Only) -->
            <div class="teacher-preview">
                <video id="teacherPreview" autoplay playsinline muted></video>
            </div>
            
            <!-- Active Speaker Area -->
            <div class="active-speaker" id="activeSpeaker">
                <div class="speaker-info">
                    <strong>üé§ Active Speaker:</strong>
                    <span id="speakerName">None</span>
                    <button class="btn btn-danger btn-sm" onclick="revokeSpeaker()" id="revokeBtn">Revoke</button>
                </div>
                <div class="speaker-video" id="speakerVideo">
                    <video id="studentSpeakerVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Classroom Controls</h3>
                <div id="userRole">Role: Loading...</div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('questions')">üìù Q&A</button>
                <button class="tab" onclick="switchTab('hands')">‚úã Hands (<span id="handCount">0</span>)</button>
                <button class="tab" onclick="switchTab('participants')">üë• Students (<span id="participantCount">0</span>)</button>
            </div>
            
            <!-- Questions Tab -->
            <div class="tab-content active" id="questionsTab">
                <div class="question-list" id="questionList">
                    <!-- Questions will be added here -->
                </div>
                
                <!-- Question Input (Students Only) -->
                <div class="input-area" id="questionInputArea">
                    <div class="input-group">
                        <input type="text" id="questionInput" placeholder="Type your question..." maxlength="200">
                        <button class="btn btn-primary" onclick="sendQuestion()" id="sendQuestionBtn">Send</button>
                    </div>
                </div>
            </div>
            
            <!-- Raised Hands Tab -->
            <div class="tab-content" id="handsTab">
                <div class="hand-list" id="handList">
                    <!-- Raised hands will be added here -->
                </div>
            </div>
            
            <!-- Participants Tab -->
            <div class="tab-content" id="participantsTab">
                <div class="participant-list" id="participantList">
                    <!-- Participants will be added here -->
                </div>
            </div>
            
            <!-- Controls Area -->
            <div class="controls">
                <!-- Student Controls -->
                <div class="student-controls" id="studentControls">
                    <button class="raise-hand-btn" onclick="raiseHand()" id="raiseHandBtn">
                        <span>‚úã</span> Raise Hand
                    </button>
                    <button class="help-btn" onclick="sendConfusionAlert()">
                        <span>‚ùì</span> I Need Help
                    </button>
                </div>
                
                <!-- Teacher Controls -->
                <div class="teacher-controls" id="teacherControls">
                    <div class="controls-grid">
                        <button class="btn btn-success" onclick="startBroadcast()" id="startBroadcastBtn">
                            ‚ñ∂ Start Broadcast
                        </button>
                        <button class="btn btn-warning" onclick="toggleMuteAll()" id="muteAllBtn">
                            üîá Mute All
                        </button>
                        <button class="btn btn-danger" onclick="endClass()" id="endClassBtn">
                            ‚èπ End Class
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Message Container -->
    <div id="statusContainer"></div>

    <script>
        // ============================================
        // Configuration and State
        // ============================================
        const config = {
            roomId: '{{ room_id }}',
            username: '{{ username }}',
            role: '{{ role }}',
            maxQuestionLength: 200,
            reconnectAttempts: 5
        };

        let state = {
            socket: null,
            roomId: config.roomId,
            username: config.username,
            role: config.role,
            sid: null,
            teacherSid: null,
            isBroadcasting: false,
            isMutedAll: false,
            raisedHand: false,
            activeSpeakerSid: null,
            peerConnections: new Map(), // Map<sid, RTCPeerConnection>
            teacherStream: null,
            studentStream: null,
            participants: new Map(), // Map<sid, {username, role}>
            questions: [],
            raisedHands: new Map(), // Map<sid, {username, timestamp}>
            reconnectCount: 0
        };

        // ============================================
        // DOM Elements
        // ============================================
        const elements = {
            // Video elements
            teacherVideo: document.getElementById('teacherVideo'),
            teacherPreview: document.getElementById('teacherPreview'),
            studentSpeakerVideo: document.getElementById('studentSpeakerVideo'),
            noStream: document.getElementById('noStream'),
            
            // UI elements
            roomTitle: document.getElementById('roomTitle'),
            liveBadge: document.getElementById('liveBadge'),
            studentCount: document.getElementById('studentCount'),
            userRole: document.getElementById('userRole'),
            connectionStatus: document.getElementById('connectionStatus'),
            
            // Tabs and content
            mainStage: document.getElementById('mainStage'),
            activeSpeaker: document.getElementById('activeSpeaker'),
            speakerName: document.getElementById('speakerName'),
            speakerVideo: document.getElementById('speakerVideo'),
            revokeBtn: document.getElementById('revokeBtn'),
            
            // Lists
            questionList: document.getElementById('questionList'),
            handList: document.getElementById('handList'),
            participantList: document.getElementById('participantList'),
            
            // Counts
            handCount: document.getElementById('handCount'),
            participantCount: document.getElementById('participantCount'),
            
            // Inputs
            questionInput: document.getElementById('questionInput'),
            questionInputArea: document.getElementById('questionInputArea'),
            sendQuestionBtn: document.getElementById('sendQuestionBtn'),
            
            // Controls
            studentControls: document.getElementById('studentControls'),
            teacherControls: document.getElementById('teacherControls'),
            raiseHandBtn: document.getElementById('raiseHandBtn'),
            startBroadcastBtn: document.getElementById('startBroadcastBtn'),
            muteAllBtn: document.getElementById('muteAllBtn'),
            endClassBtn: document.getElementById('endClassBtn'),
            
            // Status
            statusContainer: document.getElementById('statusContainer')
        };

        // ============================================
        // Initialization
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            initializeSocket();
        });

        function initializeUI() {
            // Set room title
            elements.roomTitle.textContent = `Room: ${state.roomId}`;
            elements.userRole.textContent = `Role: ${state.role.toUpperCase()}`;
            
            // Show/hide controls based on role
            if (state.role === 'teacher') {
                elements.studentControls.style.display = 'none';
                elements.teacherControls.style.display = 'block';
                elements.questionInputArea.style.display = 'none';
            } else {
                elements.studentControls.style.display = 'block';
                elements.teacherControls.style.display = 'none';
                elements.questionInputArea.style.display = 'block';
            }
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && document.activeElement === elements.questionInput) {
                    sendQuestion();
                }
                if (e.key === 'h' && e.ctrlKey && state.role === 'student') {
                    e.preventDefault();
                    raiseHand();
                }
            });
        }

        // ============================================
        // Socket.IO Connection
        // ============================================
        function initializeSocket() {
            console.log('üîå Connecting to Socket.IO server...');
            elements.connectionStatus.textContent = 'Connecting...';
            elements.connectionStatus.style.color = '#f39c12';
            
            state.socket = io();
            
            // Connection events
            state.socket.on('connect', () => {
                console.log('‚úÖ Connected to server. SID:', state.socket.id);
                elements.connectionStatus.textContent = 'Connected ‚úì';
                elements.connectionStatus.style.color = '#2ecc71';
                state.sid = state.socket.id;
                state.reconnectCount = 0;
                joinRoom();
            });
            
            state.socket.on('disconnect', (reason) => {
                console.log('‚ùå Disconnected:', reason);
                elements.connectionStatus.textContent = 'Disconnected ‚úó';
                elements.connectionStatus.style.color = '#e74c3c';
                
                if (reason === 'io server disconnect') {
                    // Server initiated disconnect, need to manually reconnect
                    setTimeout(() => state.socket.connect(), 1000);
                }
            });
            
            state.socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
                elements.connectionStatus.textContent = 'Connection Error';
                elements.connectionStatus.style.color = '#e74c3c';
                
                state.reconnectCount++;
                if (state.reconnectCount <= config.reconnectAttempts) {
                    setTimeout(() => {
                        console.log(`üîÑ Reconnection attempt ${state.reconnectCount}/${config.reconnectAttempts}`);
                        state.socket.connect();
                    }, 2000 * state.reconnectCount);
                }
            });
            
            // Room events
            state.socket.on('room-joined', handleRoomJoined);
            state.socket.on('teacher-joined', handleTeacherJoined);
            state.socket.on('teacher-disconnected', handleTeacherDisconnected);
            state.socket.on('new-participant', handleNewParticipant);
            state.socket.on('participant-left', handleParticipantLeft);
            state.socket.on('room-state', handleRoomState);
            
            // WebRTC events
            state.socket.on('webrtc-offer', handleWebRTCOffer);
            state.socket.on('webrtc-answer', handleWebRTCAnswer);
            state.socket.on('webrtc-ice-candidate', handleWebRTCICECandidate);
            state.socket.on('start-broadcast', handleStartBroadcast);
            
            // Custom events for broadcast mode
            state.socket.on('you-are-approved', handleYouAreApproved);
            state.socket.on('you-are-revoked', handleYouAreRevoked);
            state.socket.on('hand-lowered', handleHandLowered);
            state.socket.on('new-question', handleNewQuestion);
            state.socket.on('new-raised-hand', handleNewRaisedHand);
            state.socket.on('raised-hand-removed', handleRaisedHandRemoved);
            
            state.socket.on('error', (data) => {
                showStatus(data.message || 'An error occurred', 'warning');
                console.error('Server error:', data);
            });
        }

        function joinRoom() {
            console.log(`üö™ Joining room: ${state.roomId} as ${state.username} (${state.role})`);
            
            state.socket.emit('join-room', {
                room: state.roomId,
                username: state.username,
                role: state.role
            });
        }

        // ============================================
        // Event Handlers
        // ============================================
        function handleRoomJoined(data) {
            console.log('‚úÖ Room joined:', data);
            
            state.sid = data.sid;
            state.teacherSid = data.teacher_sid;
            
            // Add existing participants
            if (data.existing_participants) {
                data.existing_participants.forEach(participant => {
                    state.participants.set(participant.sid, {
                        username: participant.username,
                        role: participant.role
                    });
                });
            }
            
            updateParticipantsList();
            
            if (data.teacher_sid) {
                console.log('üë®‚Äçüè´ Teacher already in room:', data.teacher_sid);
                if (state.role === 'student') {
                    // Student: Wait for teacher's offer
                    console.log('üéì Student waiting for teacher stream...');
                }
            } else if (state.role === 'teacher') {
                console.log('üë®‚Äçüè´ You are the teacher. Ready to start broadcast.');
            }
            
            showStatus('Successfully joined classroom', 'success');
        }

        function handleTeacherJoined(data) {
            console.log('üë®‚Äçüè´ Teacher joined:', data);
            state.teacherSid = data.teacher_sid;
            
            // Add teacher to participants
            state.participants.set(data.teacher_sid, {
                username: data.teacher_name,
                role: 'teacher'
            });
            
            updateParticipantsList();
            
            if (state.role === 'student') {
                showStatus('Teacher has joined the classroom', 'info');
            }
        }

        function handleTeacherDisconnected() {
            console.log('üë®‚Äçüè´ Teacher disconnected');
            state.teacherSid = null;
            state.isBroadcasting = false;
            
            // Clear teacher video
            elements.teacherVideo.srcObject = null;
            elements.noStream.style.display = 'flex';
            elements.liveBadge.classList.remove('active');
            elements.mainStage.classList.remove('broadcast-active');
            
            // Close all peer connections
            closeAllPeerConnections();
            
            if (state.role === 'student') {
                showStatus('Teacher has left. Waiting for teacher to return...', 'warning');
            }
        }

        function handleNewParticipant(data) {
            console.log('üë§ New participant:', data);
            
            state.participants.set(data.sid, {
                username: data.username,
                role: data.role
            });
            
            updateParticipantsList();
            
            // If teacher and broadcasting, create peer connection for new student
            if (state.role === 'teacher' && state.isBroadcasting && data.role === 'student') {
                console.log(`üîó Creating connection for new student: ${data.sid}`);
                createTeacherToStudentConnection(data.sid);
            }
        }

        function handleParticipantLeft(data) {
            console.log('üë§ Participant left:', data);
            
            state.participants.delete(data.sid);
            
            // Remove from raised hands
            if (state.raisedHands.has(data.sid)) {
                state.raisedHands.delete(data.sid);
                updateRaisedHandsList();
            }
            
            // Close peer connection if exists
            if (state.peerConnections.has(data.sid)) {
                const pc = state.peerConnections.get(data.sid);
                if (pc) {
                    pc.close();
                }
                state.peerConnections.delete(data.sid);
            }
            
            updateParticipantsList();
        }

        function handleRoomState(data) {
            console.log('‚öôÔ∏è Room state updated:', data);
            state.isMutedAll = data.muted_all || false;
            
            if (state.role === 'student') {
                // Update UI based on mute state
                if (state.isMutedAll) {
                    showStatus('Teacher has muted all students', 'warning');
                }
            }
        }

        // ============================================
        // WebRTC Handlers
        // ============================================
        function handleWebRTCOffer(data) {
            console.log('üì® Received WebRTC offer from:', data.from_sid);
            
            // Students: Handle offer from teacher
            if (state.role === 'student' && data.from_sid === state.teacherSid) {
                console.log('üéì Accepting teacher stream offer');
                acceptTeacherOffer(data);
            }
            // Teacher: Handle offer from approved student
            else if (state.role === 'teacher') {
                console.log('üë®‚Äçüè´ Accepting student stream offer');
                acceptStudentOffer(data);
            }
        }

        function handleWebRTCAnswer(data) {
            console.log('üì® Received WebRTC answer from:', data.from_sid);
            
            const pc = state.peerConnections.get(data.from_sid);
            if (pc && pc.signalingState !== 'closed') {
                pc.setRemoteDescription(new RTCSessionDescription(data.answer))
                    .catch(err => console.error('Error setting remote description:', err));
            }
        }

        function handleWebRTCICECandidate(data) {
            console.log('üì® Received ICE candidate from:', data.from_sid);
            
            const pc = state.peerConnections.get(data.from_sid);
            if (pc && pc.signalingState !== 'closed' && data.candidate) {
                pc.addIceCandidate(new RTCIceCandidate(data.candidate))
                    .catch(err => console.error('Error adding ICE candidate:', err));
            }
        }

        function handleStartBroadcast(data) {
            // This event is for students when teacher starts broadcast
            if (state.role === 'student') {
                console.log('üì¢ Teacher started broadcast');
                showStatus('Teacher started the broadcast', 'info');
            }
        }

        // ============================================
        // Custom Event Handlers
        // ============================================
        function handleYouAreApproved() {
            console.log('üé§ You are approved to speak!');
            showStatus('You are now unmuted! You can speak.', 'success');
            
            if (state.role === 'student') {
                // Enable microphone and start sending stream to teacher
                startStudentStreaming();
            }
        }

        function handleYouAreRevoked() {
            console.log('üîá Your speaking privileges have been revoked');
            showStatus('You are now muted', 'warning');
            
            if (state.role === 'student') {
                // Stop sending stream
                stopStudentStreaming();
            }
        }

        function handleHandLowered() {
            console.log('‚úã Your hand has been lowered');
            state.raisedHand = false;
            elements.raiseHandBtn.disabled = false;
            elements.raiseHandBtn.innerHTML = '<span>‚úã</span> Raise Hand';
            showStatus('Your hand has been lowered', 'info');
        }

        function handleNewQuestion(data) {
            console.log('‚ùì New question:', data);
            addQuestionToList(data);
        }

        function handleNewRaisedHand(data) {
            console.log('‚úã New raised hand:', data);
            
            if (state.role === 'teacher') {
                state.raisedHands.set(data.sid, {
                    username: data.username,
                    timestamp: data.timestamp
                });
                updateRaisedHandsList();
                
                // Show notification
                showStatus(`${data.username} raised their hand`, 'info');
            }
        }

        function handleRaisedHandRemoved(data) {
            console.log('‚úã Raised hand removed:', data);
            
            if (state.role === 'teacher') {
                state.raisedHands.delete(data.sid);
                updateRaisedHandsList();
            }
        }

        // ============================================
        // WebRTC Functions
        // ============================================
        async function startTeacherBroadcast() {
            console.log('üé¨ Starting teacher broadcast...');
            
            try {
                // Get teacher's media stream
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };
                
                state.teacherStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('‚úÖ Got teacher media stream');
                
                // Show preview
                elements.teacherPreview.srcObject = state.teacherStream;
                
                // Create peer connections for all existing students
                const studentSids = Array.from(state.participants.entries())
                    .filter(([sid, data]) => data.role === 'student')
                    .map(([sid, data]) => sid);
                
                console.log(`üîó Creating connections for ${studentSids.length} students`);
                
                for (const studentSid of studentSids) {
                    createTeacherToStudentConnection(studentSid);
                }
                
                // Update UI
                state.isBroadcasting = true;
                elements.liveBadge.classList.add('active');
                elements.mainStage.classList.add('broadcast-active');
                elements.noStream.style.display = 'none';
                elements.startBroadcastBtn.disabled = true;
                elements.startBroadcastBtn.textContent = '‚óè Broadcasting';
                elements.startBroadcastBtn.classList.remove('btn-success');
                elements.startBroadcastBtn.classList.add('btn-danger');
                
                // Notify all students
                state.socket.emit('start-broadcast', { room: state.roomId });
                
                showStatus('Broadcast started successfully', 'success');
                
            } catch (error) {
                console.error('‚ùå Error starting broadcast:', error);
                showStatus(`Failed to start broadcast: ${error.message}`, 'warning');
            }
        }

        function createTeacherToStudentConnection(studentSid) {
            console.log(`üîó Creating connection to student: ${studentSid}`);
            
            // Create RTCPeerConnection
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            // Add teacher's stream tracks
            if (state.teacherStream) {
                state.teacherStream.getTracks().forEach(track => {
                    pc.addTrack(track, state.teacherStream);
                });
            }
            
            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    state.socket.emit('webrtc-ice-candidate', {
                        room: state.roomId,
                        target_sid: studentSid,
                        candidate: event.candidate
                    });
                }
            };
            
            // Create and send offer
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    state.socket.emit('webrtc-offer', {
                        room: state.roomId,
                        target_sid: studentSid,
                        offer: pc.localDescription
                    });
                    console.log(`üì§ Sent offer to student: ${studentSid}`);
                })
                .catch(err => console.error('Error creating offer:', err));
            
            // Store the connection
            state.peerConnections.set(studentSid, pc);
            
            // Handle connection state
            pc.onconnectionstatechange = () => {
                console.log(`Connection state with ${studentSid}: ${pc.connectionState}`);
                
                if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                    setTimeout(() => {
                        if (pc.connectionState === 'failed') {
                            console.log(`Reconnecting to ${studentSid}...`);
                            // Could implement reconnection logic here
                        }
                    }, 2000);
                }
                
                if (pc.connectionState === 'closed') {
                    state.peerConnections.delete(studentSid);
                }
            };
        }

        async function acceptTeacherOffer(data) {
            try {
                console.log('üéì Accepting teacher offer...');
                
                // Create RTCPeerConnection for receiving teacher stream
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                // Handle incoming track (teacher's video/audio)
                pc.ontrack = (event) => {
                    console.log('üìπ Received teacher track:', event.track.kind);
                    
                    if (event.streams && event.streams[0]) {
                        elements.teacherVideo.srcObject = event.streams[0];
                        elements.noStream.style.display = 'none';
                    }
                };
                
                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        state.socket.emit('webrtc-ice-candidate', {
                            room: state.roomId,
                            target_sid: data.from_sid,
                            candidate: event.candidate
                        });
                    }
                };
                
                // Set remote description
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                // Create and send answer
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                state.socket.emit('webrtc-answer', {
                    room: state.roomId,
                    target_sid: data.from_sid,
                    answer: pc.localDescription
                });
                
                console.log('‚úÖ Successfully accepted teacher offer');
                state.peerConnections.set(data.from_sid, pc);
                
            } catch (error) {
                console.error('‚ùå Error accepting teacher offer:', error);
                showStatus('Failed to connect to teacher stream', 'warning');
            }
        }

        async function acceptStudentOffer(data) {
            try {
                console.log(`üë®‚Äçüè´ Accepting student offer from: ${data.from_sid}`);
                
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                // Handle incoming track (student's audio/video)
                pc.ontrack = (event) => {
                    console.log(`üé§ Received student track from ${data.from_sid}:`, event.track.kind);
                    
                    if (event.streams && event.streams[0]) {
                        // Show active speaker UI
                        const student = state.participants.get(data.from_sid);
                        if (student) {
                            elements.speakerName.textContent = student.username;
                            elements.activeSpeaker.classList.add('active');
                            
                            // If video track exists, show it
                            const videoTrack = event.streams[0].getVideoTracks()[0];
                            if (videoTrack) {
                                elements.studentSpeakerVideo.srcObject = event.streams[0];
                                elements.speakerVideo.style.display = 'block';
                            }
                            
                            state.activeSpeakerSid = data.from_sid;
                        }
                    }
                };
                
                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        state.socket.emit('webrtc-ice-candidate', {
                            room: state.roomId,
                            target_sid: data.from_sid,
                            candidate: event.candidate
                        });
                    }
                };
                
                // Set remote description
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                // Create and send answer
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                state.socket.emit('webrtc-answer', {
                    room: state.roomId,
                    target_sid: data.from_sid,
                    answer: pc.localDescription
                });
                
                console.log(`‚úÖ Successfully accepted student offer from ${data.from_sid}`);
                state.peerConnections.set(data.from_sid, pc);
                
            } catch (error) {
                console.error('‚ùå Error accepting student offer:', error);
            }
        }

        async function startStudentStreaming() {
            try {
                console.log('üé§ Student starting to stream audio...');
                
                // Get student's audio stream
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false // Students don't send video by default
                };
                
                state.studentStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('‚úÖ Got student audio stream');
                
                // Create RTCPeerConnection to teacher
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                // Add audio track
                const audioTrack = state.studentStream.getAudioTracks()[0];
                if (audioTrack) {
                    pc.addTrack(audioTrack, state.studentStream);
                }
                
                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate && state.teacherSid) {
                        state.socket.emit('webrtc-ice-candidate', {
                            room: state.roomId,
                            target_sid: state.teacherSid,
                            candidate: event.candidate
                        });
                    }
                };
                
                // Create and send offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                state.socket.emit('webrtc-offer', {
                    room: state.roomId,
                    target_sid: state.teacherSid,
                    offer: pc.localDescription
                });
                
                console.log('üì§ Sent audio offer to teacher');
                state.peerConnections.set(state.teacherSid + '-audio', pc);
                
            } catch (error) {
                console.error('‚ùå Error starting student stream:', error);
                showStatus('Failed to enable microphone. Please check permissions.', 'warning');
            }
        }

        function stopStudentStreaming() {
            console.log('üîá Stopping student stream');
            
            // Close the audio peer connection
            const pcKey = state.teacherSid + '-audio';
            const pc = state.peerConnections.get(pcKey);
            if (pc) {
                pc.close();
                state.peerConnections.delete(pcKey);
            }
            
            // Stop the media stream
            if (state.studentStream) {
                state.studentStream.getTracks().forEach(track => track.stop());
                state.studentStream = null;
            }
            
            // Clear active speaker UI if this student was speaking
            if (state.activeSpeakerSid === state.sid) {
                elements.activeSpeaker.classList.remove('active');
                elements.speakerVideo.style.display = 'none';
                state.activeSpeakerSid = null;
            }
        }

        function closeAllPeerConnections() {
            console.log('üîå Closing all peer connections');
            
            state.peerConnections.forEach((pc, key) => {
                if (pc && typeof pc.close === 'function') {
                    pc.close();
                }
            });
            
            state.peerConnections.clear();
            
            // Stop all media streams
            if (state.teacherStream) {
                state.teacherStream.getTracks().forEach(track => track.stop());
                state.teacherStream = null;
            }
            
            if (state.studentStream) {
                state.studentStream.getTracks().forEach(track => track.stop());
                state.studentStream = null;
            }
        }

        // ============================================
        // UI Control Functions
        // ============================================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activate selected tab
            if (tabName === 'questions') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                elements.questionsTab.classList.add('active');
            } else if (tabName === 'hands') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                elements.handsTab.classList.add('active');
            } else if (tabName === 'participants') {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                elements.participantsTab.classList.add('active');
            }
        }

        function updateParticipantsList() {
            elements.participantList.innerHTML = '';
            let studentCount = 0;
            
            state.participants.forEach((data, sid) => {
                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant-item';
                
                let roleClass = 'role-student';
                if (data.role === 'teacher') roleClass = 'role-teacher';
                if (sid === state.activeSpeakerSid) roleClass = 'role-speaking';
                
                participantDiv.innerHTML = `
                    <div>
                        <strong>${data.username}</strong>
                        ${sid === state.sid ? ' (You)' : ''}
                    </div>
                    <div class="participant-role ${roleClass}">
                        ${data.role.toUpperCase()}
                    </div>
                `;
                
                elements.participantList.appendChild(participantDiv);
                
                if (data.role === 'student') {
                    studentCount++;
                }
            });
            
            elements.studentCount.textContent = studentCount;
            elements.participantCount.textContent = state.participants.size;
        }

        function updateRaisedHandsList() {
            elements.handList.innerHTML = '';
            elements.handCount.textContent = state.raisedHands.size;
            
            if (state.raisedHands.size === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'question-item';
                emptyMsg.textContent = 'No raised hands yet';
                elements.handList.appendChild(emptyMsg);
                return;
            }
            
            state.raisedHands.forEach((data, sid) => {
                const handDiv = document.createElement('div');
                handDiv.className = 'hand-item';
                
                const timeAgo = formatTimeAgo(data.timestamp);
                
                handDiv.innerHTML = `
                    <div class="hand-info">
                        <div class="hand-username">${data.username}</div>
                        <div class="hand-time">Raised ${timeAgo}</div>
                    </div>
                `;
                
                if (state.role === 'teacher') {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'hand-actions';
                    
                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'btn btn-success btn-sm';
                    approveBtn.textContent = 'Allow to Speak';
                    approveBtn.onclick = () => approveSpeaker(sid);
                    
                    const dismissBtn = document.createElement('button');
                    dismissBtn.className = 'btn btn-warning btn-sm';
                    dismissBtn.textContent = 'Dismiss';
                    dismissBtn.onclick = () => dismissHand(sid);
                    
                    actionsDiv.appendChild(approveBtn);
                    actionsDiv.appendChild(dismissBtn);
                    handDiv.appendChild(actionsDiv);
                }
                
                elements.handList.appendChild(handDiv);
            });
        }

        function addQuestionToList(questionData) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.id = `question-${questionData.id}`;
            
            const timeAgo = formatTimeAgo(new Date().toISOString());
            
            questionDiv.innerHTML = `
                <div class="question-header">
                    <span><strong>${questionData.username}</strong></span>
                    <span>${timeAgo}</span>
                </div>
                <div class="question-text">${escapeHtml(questionData.text)}</div>
            `;
            
            if (state.role === 'teacher') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'question-actions';
                
                const pinBtn = document.createElement('button');
                pinBtn.className = 'btn btn-primary btn-sm';
                pinBtn.textContent = 'üìå Pin';
                pinBtn.onclick = () => pinQuestion(questionData.id);
                
                const highlightBtn = document.createElement('button');
                highlightBtn.className = 'btn btn-success btn-sm';
                highlightBtn.textContent = '‚≠ê Highlight';
                highlightBtn.onclick = () => highlightQuestion(questionData.id);
                
                actionsDiv.appendChild(pinBtn);
                actionsDiv.appendChild(highlightBtn);
                questionDiv.appendChild(actionsDiv);
            }
            
            elements.questionList.insertBefore(questionDiv, elements.questionList.firstChild);
            
            // Keep only last 50 questions
            const allQuestions = elements.questionList.querySelectorAll('.question-item');
            if (allQuestions.length > 50) {
                elements.questionList.removeChild(allQuestions[allQuestions.length - 1]);
            }
        }

        // ============================================
        // User Action Functions
        // ============================================
        function raiseHand() {
            if (state.raisedHand) {
                showStatus('You already have your hand raised', 'warning');
                return;
            }
            
            console.log('‚úã Raising hand');
            state.raisedHand = true;
            elements.raiseHandBtn.disabled = true;
            elements.raiseHandBtn.innerHTML = '<span>‚úã</span> Hand Raised';
            
            state.socket.emit('raise-hand', {
                room: state.roomId,
                username: state.username,
                sid: state.sid
            });
            
            showStatus('Hand raised! Teacher will call on you soon.', 'info');
        }

        function sendQuestion() {
            const questionText = elements.questionInput.value.trim();
            
            if (!questionText) {
                showStatus('Please enter a question', 'warning');
                return;
            }
            
            if (questionText.length > config.maxQuestionLength) {
                showStatus(`Question too long (max ${config.maxQuestionLength} characters)`, 'warning');
                return;
            }
            
            console.log('‚ùì Sending question:', questionText);
            
            state.socket.emit('send-question', {
                room: state.roomId,
                username: state.username,
                sid: state.sid,
                text: questionText
            });
            
            // Add to local list immediately
            addQuestionToList({
                id: Date.now(),
                username: state.username,
                text: questionText
            });
            
            elements.questionInput.value = '';
            elements.questionInput.focus();
            
            showStatus('Question sent successfully', 'success');
        }

        function sendConfusionAlert() {
            console.log('‚ùì Sending confusion alert');
            
            state.socket.emit('confusion-alert', {
                room: state.roomId
            });
            
            showStatus('Teacher notified that you need help', 'success');
        }

        function startBroadcast() {
            if (state.role !== 'teacher') return;
            startTeacherBroadcast();
        }

        function toggleMuteAll() {
            if (state.role !== 'teacher') return;
            
            state.isMutedAll = !state.isMutedAll;
            
            state.socket.emit(state.isMutedAll ? 'teacher-mute-all' : 'teacher-unmute-all', {
                room: state.roomId
            });
            
            elements.muteAllBtn.textContent = state.isMutedAll ? 'üîä Unmute All' : 'üîá Mute All';
            elements.muteAllBtn.classList.toggle('btn-warning', !state.isMutedAll);
            elements.muteAllBtn.classList.toggle('btn-success', state.isMutedAll);
            
            showStatus(state.isMutedAll ? 'All students muted' : 'All students unmuted', 'info');
        }

        function endClass() {
            if (state.role !== 'teacher') return;
            
            if (confirm('Are you sure you want to end the class? This will disconnect all students.')) {
                console.log('‚èπ Ending class');
                
                // Close all connections
                closeAllPeerConnections();
                
                // Update UI
                state.isBroadcasting = false;
                elements.liveBadge.classList.remove('active');
                elements.mainStage.classList.remove('broadcast-active');
                elements.noStream.style.display = 'flex';
                elements.startBroadcastBtn.disabled = false;
                elements.startBroadcastBtn.textContent = '‚ñ∂ Start Broadcast';
                elements.startBroadcastBtn.classList.remove('btn-danger');
                elements.startBroadcastBtn.classList.add('btn-success');
                
                showStatus('Class ended. All students disconnected.', 'info');
            }
        }

        function approveSpeaker(studentSid) {
            if (state.role !== 'teacher') return;
            
            console.log(`‚úÖ Approving speaker: ${studentSid}`);
            
            state.socket.emit('approve-speaker', {
                room: state.roomId,
                target_student_sid: studentSid
            });
            
            // Remove from raised hands list
            state.raisedHands.delete(studentSid);
            updateRaisedHandsList();
            
            const student = state.participants.get(studentSid);
            if (student) {
                showStatus(`${student.username} is now unmuted and can speak`, 'success');
            }
        }

        function dismissHand(studentSid) {
            if (state.role !== 'teacher') return;
            
            console.log(`‚ùå Dismissing hand: ${studentSid}`);
            
            // Notify student their hand was lowered
            state.socket.emit('hand-lowered', {
                room: state.roomId,
                target_sid: studentSid
            });
            
            // Remove from raised hands list
            state.raisedHands.delete(studentSid);
            updateRaisedHandsList();
            
            const student = state.participants.get(studentSid);
            if (student) {
                showStatus(`Dismissed ${student.username}'s raised hand`, 'info');
            }
        }

        function revokeSpeaker() {
            if (state.role !== 'teacher' || !state.activeSpeakerSid) return;
            
            console.log(`üîá Revoking speaker: ${state.activeSpeakerSid}`);
            
            state.socket.emit('revoke-speaker', {
                room: state.roomId,
                target_student_sid: state.activeSpeakerSid
            });
            
            // Clear active speaker UI
            elements.activeSpeaker.classList.remove('active');
            elements.speakerVideo.style.display = 'none';
            
            const student = state.participants.get(state.activeSpeakerSid);
            if (student) {
                showStatus(`${student.username} is now muted`, 'warning');
            }
            
            state.activeSpeakerSid = null;
        }

        function pinQuestion(questionId) {
            console.log(`üìå Pinning question: ${questionId}`);
            showStatus('Question pinned (feature to be implemented)', 'info');
        }

        function highlightQuestion(questionId) {
            console.log(`‚≠ê Highlighting question: ${questionId}`);
            const questionDiv = document.getElementById(`question-${questionId}`);
            if (questionDiv) {
                questionDiv.style.backgroundColor = '#fff3cd';
                questionDiv.style.borderLeftColor = '#ffc107';
            }
            showStatus('Question highlighted', 'success');
        }

        // ============================================
        // Utility Functions
        // ============================================
        function showStatus(message, type = 'info') {
            console.log(`üì¢ Status (${type}): ${message}`);
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            
            elements.statusContainer.appendChild(statusDiv);
            statusDiv.style.display = 'block';
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.style.opacity = '0';
                    statusDiv.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (statusDiv.parentNode) {
                            elements.statusContainer.removeChild(statusDiv);
                        }
                    }, 300);
                }
            }, 5000);
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins === 1) return '1 minute ago';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours === 1) return '1 hour ago';
            if (diffHours < 24) return `${diffHours} hours ago`;
            
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays === 1) return '1 day ago';
            return `${diffDays} days ago`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // Cleanup on Page Unload
        // ============================================
        window.addEventListener('beforeunload', () => {
            console.log('üßπ Cleaning up before unload');
            
            // Close all WebRTC connections
            closeAllPeerConnections();
            
            // Notify server we're leaving
            if (state.socket && state.socket.connected) {
                state.socket.disconnect();
            }
        });

        // ============================================
        // Export functions for onclick handlers
        // ============================================
        window.switchTab = switchTab;
        window.raiseHand = raiseHand;
        window.sendQuestion = sendQuestion;
        window.sendConfusionAlert = sendConfusionAlert;
        window.startBroadcast = startBroadcast;
        window.toggleMuteAll = toggleMuteAll;
        window.endClass = endClass;
        window.revokeSpeaker = revokeSpeaker;
        window.pinQuestion = pinQuestion;
        window.highlightQuestion = highlightQuestion;
        window.approveSpeaker = approveSpeaker;
        window.dismissHand = dismissHand;
    </script>
</body>
</html>
