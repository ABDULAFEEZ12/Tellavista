<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Nelavista · LASU Campus Map</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    body {
      background-color: #fafafa;
      color: #333;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .header {
      background-color: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 1rem 1.2rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      flex: 1 1 300px;
    }

    .header-left h1 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #222;
      margin-bottom: 0.3rem;
    }

    .header-left p {
      font-size: 0.85rem;
      color: #666;
      max-width: 600px;
    }

    .location-dropdown {
      margin-left: 1rem;
      flex-shrink: 0;
    }

    .location-dropdown select {
      background-color: #111;
      color: white;
      border: none;
      padding: 0.5rem 2rem 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 20px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat: no-repeat;
      background-position: right 0.7rem center;
      background-size: 1rem;
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .location-dropdown select:hover {
      background-color: #333;
    }

    .location-dropdown select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
    }

    /* Location permission banner */
    .location-prompt {
      background-color: #f0f7ff;
      border-bottom: 1px solid #b8d4f0;
      padding: 0.6rem 1.2rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      font-size: 0.95rem;
      color: #1a3e6f;
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
      transition: all 0.2s ease;
    }
    .location-prompt.hidden {
      display: none;
    }
    .prompt-message i {
      margin-right: 0.5rem;
      color: #0066cc;
    }
    .prompt-actions {
      display: flex;
      gap: 0.6rem;
      flex-shrink: 0;
    }
    .prompt-btn {
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 30px;
      font-weight: 500;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      touch-action: manipulation;
    }
    .prompt-btn.primary {
      background-color: #0066cc;
      color: white;
    }
    .prompt-btn.primary:hover,
    .prompt-btn.primary:active {
      background-color: #004999;
    }
    .prompt-btn.secondary {
      background-color: #e2eaf6;
      color: #1a3e6f;
    }
    .prompt-btn.secondary:hover,
    .prompt-btn.secondary:active {
      background-color: #c9d6e8;
    }
    .prompt-btn:active {
      transform: scale(0.96);
    }

    @media (max-width: 500px) {
      .location-prompt {
        flex-direction: column;
        align-items: flex-start;
      }
      .prompt-actions {
        align-self: flex-end;
      }
    }

    .container {
      display: flex;
      flex-direction: column;
      flex: 1;
      height: calc(100vh - 140px);
    }

    @media (min-width: 768px) {
      .container {
        flex-direction: row;
      }
    }

    #map {
      flex: 1;
      min-height: 50vh;
      background-color: #e9e9e9;
      width: 100%;
      z-index: 1;
    }

    @media (min-width: 768px) {
      #map {
        min-height: calc(100vh - 120px);
      }
    }

    .sidebar {
      width: 100%;
      background-color: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 1.2rem;
      overflow-y: auto;
      max-height: 50vh;
      z-index: 1000;
    }

    @media (min-width: 768px) {
      .sidebar {
        width: 320px;
        max-width: 100%;
        border-top: none;
        border-left: 1px solid #e0e0e0;
        max-height: calc(100vh - 120px);
      }
    }

    .sidebar h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #222;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #111;
    }

    .controls {
      margin-bottom: 1.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: #111;
      color: white;
      border: none;
      padding: 0.9rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      margin-bottom: 0.8rem;
      touch-action: manipulation;
    }

    .btn:hover, .btn:active {
      background-color: #333;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn i {
      margin-right: 0.5rem;
      font-weight: bold;
    }

    .coords-box {
      font-size: 0.85rem;
      padding: 0.8rem;
      border-radius: 6px;
      margin-bottom: 1.2rem;
      background-color: #f8f8f8;
      color: #333;
      border-left: 3px solid #111;
      min-height: 50px;
      display: flex;
      align-items: center;
      word-break: break-all;
    }

    .info-panel {
      margin-top: 1.5rem;
      padding-top: 1.2rem;
      border-top: 1px solid #eee;
    }

    .info-panel p {
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .locations-list h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: #444;
    }

    .locations-list ul {
      list-style-type: none;
      max-height: 200px;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      .locations-list ul {
        max-height: 300px;
      }
    }

    .locations-list li {
      padding: 0.9rem 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
      touch-action: manipulation;
    }

    .locations-list li:hover, .locations-list li:active {
      background-color: #f9f9f9;
    }

    .locations-list li:last-child {
      border-bottom: none;
    }

    .location-marker {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.8rem;
      flex-shrink: 0;
      background-color: #111;
    }

    .location-name {
      font-weight: 500;
      font-size: 0.95rem;
    }

    .footer {
      background-color: #111;
      color: #aaa;
      text-align: center;
      padding: 1rem;
      font-size: 0.75rem;
      border-top: 1px solid #333;
    }

    .footer a {
      color: #fff;
      text-decoration: underline;
    }

    /* mobile toggle etc. (keep all existing styles) */
    .mobile-nav-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background-color: #111;
      color: white;
      border-radius: 50%;
      border: none;
      font-size: 1.5rem;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      touch-action: manipulation;
    }

    @media (max-width: 767px) {
      .mobile-nav-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 70vh;
        transform: translateY(100%);
        transition: transform 0.3s ease-in-out;
        border-top: 2px solid #111;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        padding-bottom: 80px;
      }
      
      .sidebar.active {
        transform: translateY(0);
      }
      
      #map {
        min-height: 60vh;
        height: 60vh;
      }
    }

    .leaflet-pulsing-icon {
      border-radius: 100%;
      box-shadow: 0 0 0 5px rgba(0, 102, 204, 0.4);
    }
    .leaflet-pulsing-icon::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background-color: #0066cc;
      border-radius: 100%;
    }
    .nav-line {
      stroke: #0066cc;
      stroke-width: 3;
      stroke-dasharray: 10, 5;
      fill: none;
    }
  </style>
</head>
<body>
  <header class="header">
      <h1>Nelavista LASU Campus Map</h1>
      <p>Interactive map of Lagos State University (LASU). All landmarks are fixed. Click any marker for details and navigation.</p>
    </div>
    <div class="location-dropdown">
      <select id="campusLocationSelect" aria-label="Select a campus location">
        <option value="">— Select a location —</option>
      </select>
    </div>
  </header>

  <!-- LOCATION PERMISSION BANNER (appears on first visit, unless previously dismissed) -->
  <div id="locationPrompt" class="location-prompt">
    <div class="prompt-message">
      <i class="fas fa-location-dot"></i> For a better experience, enable your location.
    </div>
    <div class="prompt-actions">
      <button class="prompt-btn primary" id="promptTurnOn"><i class="fas fa-toggle-on"></i> Turn On</button>
      <button class="prompt-btn secondary" id="promptLater">Maybe later</button>
    </div>
  </div>

  <div class="container">
    <div id="map"></div>

    <aside class="sidebar" id="sidebar">
      <h2><i class="fas fa-map-pin"></i> Campus Navigator</h2>

      <div class="controls">
        <button class="btn" onclick="locateUser()">
          <i class="fas fa-location-crosshairs"></i> Show My Location
        </button>
        
        <div class="coords-box" id="coordsBox">
          Click a landmark to see details.
        </div>

        <div class="search-container">
          <input type="text" class="search-input" id="searchInput" placeholder="Search for a building..." onfocus="onSearchFocus()">
        </div>
        
        <div class="key-hint">
          <i class="fas fa-info-circle"></i> <strong>Note:</strong> Landmarks are fixed. Use the buttons to navigate.
        </div>
      </div>

      <div class="locations-list">
        <h3><i class="fas fa-building"></i> Campus Locations</h3>
        <ul id="locationsList">
          <!-- List will be generated dynamically -->
        </ul>
      </div>

      <div class="info-panel">
        <p><i class="fas fa-info-circle"></i> <strong>Tip:</strong> Click any marker to see details and get directions from your location.</p>
        <p><i class="fas fa-database"></i> <strong>Storage:</strong> Your last view and selected location are saved.</p>
        <p><i class="fas fa-mobile-alt"></i> <strong>Mobile:</strong> Tap a location to focus, then use the Navigate button.</p>
      </div>
    </aside>
  </div>

  <button class="mobile-nav-toggle" id="mobileToggle" aria-label="Toggle navigation panel">
    <i class="fas fa-bars" id="toggleIcon"></i>
  </button>

  <footer class="footer">
    <p>Nelavista Campus Map &copy; 2026 | Lagos State University (LASU) | 
       <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors | 
       Powered by <a href="https://leafletjs.com/" target="_blank">Leaflet</a>
    </p>
    <p style="margin-top:0.3rem; font-size:0.7rem;">Student navigation tool. Landmark positions are fixed.</p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ---------- LOCATION PERMISSION PROMPT LOGIC ----------
    const promptElement = document.getElementById('locationPrompt');
    const promptTurnOn = document.getElementById('promptTurnOn');
    const promptLater = document.getElementById('promptLater');
    const DISMISSAL_KEY = 'lasu_location_prompt_dismissed';
    let promptInteracted = false;  // session flag

    // Helper to hide banner and mark as interacted (for session)
    function hideLocationPrompt() {
      if (promptElement) promptElement.classList.add('hidden');
      promptInteracted = true;
    }

    // Show banner only if not permanently dismissed & not interacted yet
    function maybeShowPrompt() {
      const permanentlyDismissed = localStorage.getItem(DISMISSAL_KEY) === 'true';
      if (!permanentlyDismissed && !promptInteracted) {
        promptElement.classList.remove('hidden');
      } else {
        promptElement.classList.add('hidden');
      }
    }

    // Event: Turn On
    promptTurnOn.addEventListener('click', function() {
      hideLocationPrompt();          // hide for this session
      // No localStorage dismissal -> will show again next session unless they dismiss permanently
      locateUser();                  // request location
    });

    // Event: Maybe later → dismiss permanently
    promptLater.addEventListener('click', function() {
      localStorage.setItem(DISMISSAL_KEY, 'true');
      hideLocationPrompt();
    });

    // Also if user manually uses "Show My Location" we can hide the prompt (they obviously engaged)
    const originalLocateUser = window.locateUser; // we'll override after function declaration, but careful with hoisting.
    // We'll patch locateUser after it's defined.

    // ---------- EXISTING MAP CODE (with minor integration) ----------
    const locations = [
      { id: "arcade", name: "Arcade (Student Commercial Hub)", coords: [6.465718, 3.203115] },
      { id: "main_auditorium", name: "Main Auditorium", coords: [6.473108, 3.201887] },
      { id: "mass_comm_hall", name: "Mass Communication Lecture Hall", coords: [6.472277, 3.200154] },
      { id: "economics_hall", name: "Economics Hall", coords: [6.475243, 3.199060] },
      { id: "library", name: "Main Library", coords: [6.464857, 3.200701] },
      { id: "science_library", name: "Science Library", coords: [6.464526, 3.199186] },
      { id: "law_library", name: "Law Library", coords: [6.464095, 3.200192] },
      { id: "cbt_center", name: "CBT Center (Exam Hall)", coords: [6.475192, 3.201302] },
      { id: "ict", name: "ICT Building", coords: [6.468753, 3.201230] },
      { id: "health", name: "Health Center", coords: [6.465443, 3.202018] },
      { id: "sports", name: "Sports Center", coords: [6.469750, 3.202550] },
      { id: "education", name: "Faculty of Education", coords: [6.472996, 3.199889] },
      { id: "arts", name: "Faculty of Arts", coords: [6.464550, 3.201790] },
      { id: "law", name: "Faculty of Law", coords: [6.467085, 3.202029] },
      { id: "management_sciences", name: "Faculty of Management Sciences", coords: [6.475661, 3.199942] },
      { id: "sciences", name: "Faculty of Sciences", coords: [6.466275, 3.200283] },
      { id: "social_sciences", name: "Faculty of Social Sciences", coords: [6.475243, 3.199060] },
      { id: "school_of_transport", name: "School of Transport and Logistics", coords: [6.474193, 3.198038] },
      { id: "post_graduate_school", name: "Post Graduate School", coords: [6.468391, 3.201227] },
      { id: "bank_arena", name: "Bank Arena", coords: [6.464388, 3.204019] },
      { id: "mosque", name: "LASU Central Mosque", coords: [6.465425, 3.200015] },
      { id: "lasu_shuttle_park", name: "LASU Shuttle Park", coords: [6.475243, 3.199060] }
    ];

    const lasuCenter = [6.4700, 3.2000];
    const map = L.map("map", {
      maxZoom: 21,
      zoomControl: true,
      tap: true,
      touchZoom: true,
      dragging: true,
      scrollWheelZoom: true
    }).setView(lasuCenter, 15);

    const streetLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© OpenStreetMap contributors | © <a href="https://www.esri.com/">Esri</a>',
      maxZoom: 19
    });

    const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: '© OpenStreetMap contributors | Tiles © Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community',
      maxZoom: 20
    });

    const terrainLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}", {
      attribution: '© OpenStreetMap contributors | Tiles © Esri &mdash; Esri, DeLorme, NAVTEQ',
      maxZoom: 19
    });

    const hybridLayer = L.layerGroup([
      L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        attribution: '© OpenStreetMap contributors | Tiles © Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community',
        maxZoom: 20
      }),
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        opacity: 0.3,
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      })
    ]);

    streetLayer.maxAvailableZoom = 19;
    satelliteLayer.maxAvailableZoom = 19;
    terrainLayer.maxAvailableZoom = 19;
    hybridLayer.maxAvailableZoom = 20;

    const baseLayers = {
      "Street": streetLayer,
      "Satellite": satelliteLayer,
      "Terrain": terrainLayer,
      "Hybrid": hybridLayer
    };

    satelliteLayer.addTo(map);

    const layerControl = L.control.layers(baseLayers, null, {
      position: 'topright',
      collapsed: true
    }).addTo(map);

    let userManualSelection = false;
    let currentBaseLayer = satelliteLayer;
    const USER_PREFERENCE_KEY = 'lasu_map_base_layer';

    function getCurrentLayerMaxZoom() {
      return currentBaseLayer.maxAvailableZoom || 19;
    }

    function updateMapZoomLimits() {
      const maxZoom = getCurrentLayerMaxZoom();
      const currentZoom = map.getZoom();
      if (currentZoom > maxZoom) map.setZoom(maxZoom);
      map.options.maxZoom = maxZoom;
      if (map.zoomControl) map.zoomControl._updateDisabled();
    }

    function clampZoomToLayer() {
      const maxZoom = getCurrentLayerMaxZoom();
      const currentZoom = map.getZoom();
      if (currentZoom > maxZoom) map.setZoom(maxZoom);
    }

    function saveUserPreference(layerName) {
      localStorage.setItem(USER_PREFERENCE_KEY, layerName);
      userManualSelection = true;
      updateMapZoomLimits();
    }

    function restoreUserPreference() {
      const savedLayer = localStorage.getItem(USER_PREFERENCE_KEY);
      if (savedLayer && baseLayers[savedLayer]) {
        map.removeLayer(currentBaseLayer);
        baseLayers[savedLayer].addTo(map);
        currentBaseLayer = baseLayers[savedLayer];
        userManualSelection = true;
        updateMapZoomLimits();
        return true;
      }
      return false;
    }

    function autoSwitchLayerByZoom() {
      if (userManualSelection) return;
      const zoom = map.getZoom();
      let targetLayer;
      if (zoom < 16) targetLayer = streetLayer;
      else if (zoom >= 16 && zoom < 18) targetLayer = terrainLayer;
      else targetLayer = satelliteLayer;
      if (targetLayer !== currentBaseLayer) {
        map.removeLayer(currentBaseLayer);
        targetLayer.addTo(map);
        currentBaseLayer = targetLayer;
        updateMapZoomLimits();
      }
    }

    const hasRestored = restoreUserPreference();

    map.on('zoomend', function() {
      clampZoomToLayer();
      if (!userManualSelection) autoSwitchLayerByZoom();
    });

    map.on('baselayerchange', function(event) {
      const layerName = Object.keys(baseLayers).find(key => baseLayers[key] === event.layer);
      if (layerName) {
        saveUserPreference(layerName);
        currentBaseLayer = event.layer;
        updateMapZoomLimits();
      }
    });

    if (!hasRestored) {
      updateMapZoomLimits();
      autoSwitchLayerByZoom();
    }

    const coordsBox = document.getElementById("coordsBox");
    const locationsList = document.getElementById("locationsList");
    let activeMarker = null;
    const markers = {};
    let userLocationMarker = null;
    let userLatLng = null;
    let navigationLine = null;
    let lastNearestMarker = null;
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileToggle');
    const toggleIcon = document.getElementById('toggleIcon');
    const locationSelect = document.getElementById('campusLocationSelect');

    function toggleSidebar() {
      sidebar.classList.toggle('active');
      if (sidebar.classList.contains('active')) {
        toggleIcon.className = 'fas fa-times';
        mobileToggle.style.backgroundColor = '#e74c3c';
      } else {
        toggleIcon.className = 'fas fa-bars';
        mobileToggle.style.backgroundColor = '#111';
      }
    }

    function closeSidebarOnMobile() {
      if (window.innerWidth < 768 && sidebar.classList.contains('active')) toggleSidebar();
    }

    function onSearchFocus() {
      if (window.innerWidth < 768) {
        sidebar.classList.add('active');
        toggleIcon.className = 'fas fa-times';
        mobileToggle.style.backgroundColor = '#e74c3c';
      }
    }

    mobileToggle.addEventListener('click', toggleSidebar);

    function getDistanceInMeters(latLng1, latLng2) {
      return latLng1.distanceTo(latLng2);
    }

    function getMarkerColor(category) {
      const colors = {
        faculty: '#3498db', department: '#9b59b6', lecture: '#1abc9c',
        administrative: '#f39c12', healthcare: '#e74c3c', religious: '#2c3e50',
        ict: '#16a085', bank: '#27ae60', sports: '#c0392b',
        commercial: '#8e44ad', utility: '#7f8c8d'
      };
      return colors[category] || '#2ecc71';
    }

    function getCategoryFromLocation(location) {
      const name = location.name.toLowerCase();
      const id = location.id.toLowerCase();
      if (name.includes('arcade') || name.includes('commercial')) return 'commercial';
      if (name.includes('mosque')) return 'religious';
      if (name.includes('bank')) return 'bank';
      if (name.includes('sport') || name.includes('court')) return 'sports';
      if (name.includes('shuttle')) return 'utility';
      if (name.includes('ict') || name.includes('cbt') || name.includes('computer')) return 'ict';
      if (name.includes('medical') || name.includes('health')) return 'healthcare';
      if (name.includes('faculty') || name.includes('school')) return 'faculty';
      if (name.includes('library') || name.includes('lab')) return 'department';
      if (name.includes('lecture') || name.includes('hall') || name.includes('auditorium')) return 'lecture';
      return 'general';
    }

    function populateSidebar() {
      locationsList.innerHTML = '';
      locations.forEach(location => {
        const li = document.createElement('li');
        li.setAttribute('data-location-id', location.id);
        li.innerHTML = `
          <div class="location-marker" style="background-color: ${getMarkerColor(getCategoryFromLocation(location))}"></div>
          <div class="location-name">${location.name}</div>
        `;
        li.onclick = () => {
          focusOnMarker(location.id);
          closeSidebarOnMobile();
        };
        locationsList.appendChild(li);
      });
    }

    function populateDropdown() {
      locationSelect.innerHTML = '<option value="">— Select a location —</option>';
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = location.name;
        locationSelect.appendChild(option);
      });
    }

    locationSelect.addEventListener('change', function(e) {
      const locationId = e.target.value;
      if (locationId) focusOnMarker(locationId);
    });

    function getSavedCoords(locationId, fallback) {
      const saved = localStorage.getItem(`lasu_${locationId}`);
      return saved ? JSON.parse(saved) : fallback;
    }

    function saveCoords(locationId, latlng) {
      localStorage.setItem(`lasu_${locationId}`, JSON.stringify([latlng.lat, latlng.lng]));
    }

    function findLocationById(id) {
      return locations.find(loc => loc.id === id);
    }

    function createNavigationLine(fromLatLng, toLatLng) {
      if (navigationLine) map.removeLayer(navigationLine);
      navigationLine = L.polyline([fromLatLng, toLatLng], {
        color: '#0066cc', weight: 3, opacity: 0.7, dashArray: '10, 5', className: 'nav-line'
      }).addTo(map);
      const distance = getDistanceInMeters(fromLatLng, toLatLng);
      navigationLine.bindTooltip(`Distance: ${Math.round(distance)} meters`, { permanent: false, direction: 'top' });
      return navigationLine;
    }

    function initializeMarkers() {
      locations.forEach(location => {
        const startCoords = getSavedCoords(location.id, location.coords);
        const category = getCategoryFromLocation(location);
        const marker = L.marker(startCoords, { 
          draggable: false,
          title: location.name,
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${getMarkerColor(category)}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
            iconSize: [18, 18],
            iconAnchor: [9, 9]
          })
        }).addTo(map);
        
        const popupContent = `<strong>${location.name}</strong><br><button class="nav-btn" onclick="navigateToMarker('${location.id}'); closeSidebarOnMobile();">Navigate from my location</button>`;
        marker.bindPopup(popupContent);
        marker.locationData = location;
        marker.on("click", () => {
          activeMarker = marker;
          coordsBox.textContent = `${location.name} selected`;
          locationSelect.value = location.id;
          saveState('marker', location.id);
          closeSidebarOnMobile();
        });
        markers[location.id] = marker;
      });
    }

    function focusOnMarker(locationId) {
      const marker = markers[locationId];
      const location = findLocationById(locationId);
      if (marker && location) {
        map.setView(marker.getLatLng(), Math.min(17, getCurrentLayerMaxZoom()));
        marker.openPopup();
        activeMarker = marker;
        coordsBox.textContent = `${location.name} selected`;
        locationSelect.value = locationId;
        saveState('marker', locationId);
      } else {
        coordsBox.textContent = `Location data not available.`;
      }
    }

    function findNearestBuilding(userLatLng) {
      let nearestDistance = Infinity, nearestLocation = null;
      locations.forEach(location => {
        const marker = markers[location.id];
        if (marker) {
          const distance = getDistanceInMeters(userLatLng, marker.getLatLng());
          if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestLocation = location;
          }
        }
      });
      return { location: nearestLocation, distance: nearestDistance };
    }

    // ----- PATCH locateUser to also hide prompt on use -----
    window.locateUser = function() {
      // Hide location prompt if visible (user engaged)
      hideLocationPrompt();

      if (!navigator.geolocation) {
        coordsBox.textContent = "Geolocation is not supported by your browser";
        return;
      }
      coordsBox.textContent = "Locating...";
      navigator.geolocation.getCurrentPosition(position => {
        const userCoords = [position.coords.latitude, position.coords.longitude];
        userLatLng = L.latLng(userCoords[0], userCoords[1]);
        const lasuCenterLatLng = L.latLng(lasuCenter[0], lasuCenter[1]);
        const distanceFromCampus = getDistanceInMeters(userLatLng, lasuCenterLatLng);
        if (distanceFromCampus > 2000) {
          coordsBox.textContent = "You are outside LASU campus. Showing campus instead.";
          map.setView(lasuCenter, Math.min(17, getCurrentLayerMaxZoom()));
          return;
        }
        if (userLocationMarker) map.removeLayer(userLocationMarker);
        const blueDotIcon = L.divIcon({
          className: 'leaflet-pulsing-icon',
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        userLocationMarker = L.marker(userCoords, { icon: blueDotIcon }).addTo(map).bindPopup("You are here").openPopup();
        map.setView(userCoords, Math.min(17, getCurrentLayerMaxZoom()));
        const nearest = findNearestBuilding(userLatLng);
        if (nearest.location) {
          coordsBox.textContent = `Nearest building: ${nearest.location.name} – ${Math.round(nearest.distance)} meters away`;
          if (lastNearestMarker) lastNearestMarker.closePopup();
          markers[nearest.location.id].openPopup();
          lastNearestMarker = markers[nearest.location.id];
        }
        saveState('view', null);
        closeSidebarOnMobile();
      }, () => {
        coordsBox.textContent = "Location access denied or unavailable";
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    };

    window.navigateToMarker = function(locationId) {
      if (!userLatLng) {
        alert("Please enable location services and click 'Show My Location' first.");
        return;
      }
      const marker = markers[locationId];
      if (marker) {
        createNavigationLine(userLatLng, marker.getLatLng());
        marker.openPopup();
      }
    };

    function saveState(type, value) {
      if (type === 'marker') localStorage.setItem('lasu_last_marker', value);
      else if (type === 'view') {
        const center = map.getCenter();
        localStorage.setItem('lasu_map_view', JSON.stringify({ center: [center.lat, center.lng], zoom: map.getZoom() }));
      }
    }

    function restoreState() {
      const lastMarker = localStorage.getItem('lasu_last_marker');
      if (lastMarker && markers[lastMarker]) { focusOnMarker(lastMarker); return; }
      const savedView = localStorage.getItem('lasu_map_view');
      if (savedView) {
        try { const { center, zoom } = JSON.parse(savedView); map.setView(center, zoom); } catch(e) {}
      }
    }

    function searchLocations() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const listItems = document.querySelectorAll('#locationsList li');
      let firstMatch = null;
      listItems.forEach(item => {
        const locationId = item.getAttribute('data-location-id');
        const location = findLocationById(locationId);
        if (location.name.toLowerCase().includes(searchTerm)) {
          item.style.display = 'flex';
          if (!firstMatch) firstMatch = locationId;
        } else {
          item.style.display = 'none';
        }
      });
      if (firstMatch && searchTerm.length > 0) focusOnMarker(firstMatch);
    }

    document.getElementById('searchInput').addEventListener('input', searchLocations);
    map.on('moveend', () => saveState('view', null));
    map.on('click', closeSidebarOnMobile);

    // Initialize everything
    populateSidebar();
    populateDropdown();
    initializeMarkers();
    restoreState();

    // Show location prompt if not dismissed
    maybeShowPrompt();

    if (window.innerWidth < 768) {
      sidebar.classList.remove('active');
      mobileToggle.style.display = 'flex';
    }

    window.addEventListener('resize', function() {
      if (window.innerWidth >= 768) {
        sidebar.classList.remove('active');
        mobileToggle.style.display = 'none';
        toggleIcon.className = 'fas fa-bars';
        mobileToggle.style.backgroundColor = '#111';
      } else {
        mobileToggle.style.display = 'flex';
      }
    });
  </script>
</body>
</html>
