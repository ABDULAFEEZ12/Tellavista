<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LASU Campus Map - Student Navigation Tool</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    body {
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .header {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      padding: 1.2rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1000;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: -0.3px;
    }

    .header p {
      font-size: 0.9rem;
      opacity: 0.9;
      max-width: 600px;
      margin-bottom: 0.8rem;
    }

    .header .lasu-badge {
      display: inline-block;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(238, 90, 36, 0.3);
    }

    .container {
      display: flex;
      flex-direction: column;
      flex: 1;
      height: calc(100vh - 140px);
    }

    @media (min-width: 768px) {
      .container {
        flex-direction: row;
      }
    }

    #map {
      flex: 1;
      min-height: 50vh;
      background-color: #e9ecef;
      width: 100%;
      z-index: 1;
    }

    @media (min-width: 768px) {
      #map {
        min-height: calc(100vh - 120px);
      }
    }

    .sidebar {
      width: 100%;
      background-color: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 1.5rem;
      overflow-y: auto;
      max-height: 50vh;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    @media (min-width: 768px) {
      .sidebar {
        width: 360px;
        max-width: 100%;
        border-top: none;
        border-left: 1px solid #e0e0e0;
        max-height: calc(100vh - 120px);
        box-shadow: none;
      }
    }

    .sidebar h2 {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1.2rem;
      color: #1a237e;
      padding-bottom: 0.8rem;
      border-bottom: 2px solid #1a237e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sidebar h2 i {
      color: #ee5a24;
    }

    .controls {
      margin-bottom: 1.8rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      border: none;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
    }

    .btn:hover, .btn:active {
      background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 35, 126, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn i {
      margin-right: 0.8rem;
      font-size: 1.1rem;
    }

    .status-box {
      font-size: 0.9rem;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #495057;
      border-left: 4px solid #1a237e;
      min-height: 60px;
      display: flex;
      align-items: center;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .search-container {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      background-color: #fff;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .search-input:focus {
      outline: none;
      border-color: #1a237e;
      box-shadow: 0 4px 12px rgba(26, 35, 126, 0.15);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      font-size: 1.1rem;
    }

    .locations-list h3 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .locations-list h3 i {
      color: #1a237e;
    }

    .locations-list ul {
      list-style-type: none;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      background-color: #fff;
    }

    @media (min-width: 768px) {
      .locations-list ul {
        max-height: 320px;
      }
    }

    .locations-list li {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .locations-list li:hover {
      background-color: #f8f9fa;
      transform: translateX(4px);
    }

    .locations-list li:active {
      background-color: #e9ecef;
      transform: translateX(2px);
    }

    .locations-list li:last-child {
      border-bottom: none;
    }

    .location-marker {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 1rem;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .location-name {
      font-weight: 500;
      font-size: 1rem;
      color: #333;
    }

    .footer {
      background-color: #1a237e;
      color: rgba(255, 255, 255, 0.85);
      text-align: center;
      padding: 1.2rem;
      font-size: 0.8rem;
      border-top: 1px solid #3949ab;
    }

    .footer a {
      color: #ffd54f;
      text-decoration: none;
      transition: color 0.2s;
    }

    .footer a:hover {
      color: #fff;
      text-decoration: underline;
    }

    .leaflet-container {
      font: inherit;
    }

    .leaflet-control-attribution {
      background-color: rgba(255, 255, 255, 0.95) !important;
      color: #495057 !important;
      font-size: 0.7rem !important;
      padding: 4px 8px !important;
      border-radius: 4px !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .leaflet-control-zoom a {
      background-color: #fff;
      color: #495057;
      border: 1px solid #dee2e6;
      width: 44px !important;
      height: 44px !important;
      line-height: 44px !important;
      font-size: 1.3rem !important;
      font-weight: bold;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .leaflet-control-zoom a:hover {
      background-color: #f8f9fa;
      color: #1a237e;
    }

    .leaflet-pulsing-icon {
      border-radius: 100%;
      box-shadow: 0 0 0 8px rgba(26, 35, 126, 0.3);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(26, 35, 126, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(26, 35, 126, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(26, 35, 126, 0);
      }
    }

    .leaflet-pulsing-icon::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      background-color: #1a237e;
      border-radius: 100%;
    }

    .leaflet-control-layers-toggle {
      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMiA3TDEyIDEyTDIyIDdMMTIgMloiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTIgMTdMMTIgMjJMMjIgMTciIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTIgMTJMMTIgMTdMMjIgMTIiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cg==') !important;
      width: 44px !important;
      height: 44px !important;
      background-color: #fff !important;
      border: 1px solid #dee2e6 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .nav-btn {
      background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
      color: white;
      border: none;
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 0.8rem;
      display: inline-block;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(238, 90, 36, 0.3);
    }

    .nav-btn:hover, .nav-btn:active {
      background: linear-gradient(135deg, #d64511 0%, #ff5252 100%);
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(238, 90, 36, 0.4);
    }

    .nav-line {
      stroke: #1a237e;
      stroke-width: 4;
      stroke-dasharray: 10, 5;
      fill: none;
      opacity: 0.8;
    }

    .mobile-nav-toggle {
      display: none;
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      border-radius: 50%;
      border: none;
      font-size: 1.8rem;
      z-index: 1001;
      box-shadow: 0 6px 20px rgba(26, 35, 126, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .mobile-nav-toggle:hover {
      transform: scale(1.1);
    }

    .mobile-nav-toggle:active {
      transform: scale(0.95);
    }

    @media (max-width: 767px) {
      .mobile-nav-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 75vh;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-top: 3px solid #1a237e;
        box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.2);
        padding-bottom: 90px;
        padding-top: 1.8rem;
        border-radius: 24px 24px 0 0;
        overflow: hidden;
      }
      
      .sidebar::before {
        content: '';
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 4px;
        background-color: #e0e0e0;
        border-radius: 2px;
      }
      
      .sidebar.active {
        transform: translateY(0);
      }
      
      #map {
        min-height: 60vh;
        height: 60vh;
      }
      
      .header {
        padding: 1rem 1.2rem;
      }
      
      .header h1 {
        font-size: 1.3rem;
      }
      
      .header p {
        font-size: 0.85rem;
      }
      
      .btn {
        padding: 1.1rem;
        font-size: 1.05rem;
        border-radius: 12px;
      }
      
      .leaflet-control-zoom {
        margin-bottom: 80px !important;
      }
      
      .locations-list ul {
        max-height: 180px;
      }
      
      .sidebar h2 {
        font-size: 1.2rem;
      }
      
      .sidebar {
        padding-left: 1.2rem;
        padding-right: 1.2rem;
      }
      
      .status-box {
        padding: 1rem;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.2rem;
      }
      
      .header p {
        font-size: 0.8rem;
      }
      
      .btn {
        padding: 1rem;
        font-size: 1rem;
      }
      
      .sidebar h2 {
        font-size: 1.1rem;
      }
      
      .location-name {
        font-size: 0.95rem;
      }
      
      .status-box {
        font-size: 0.85rem;
        padding: 0.9rem;
      }
      
      .mobile-nav-toggle {
        width: 60px;
        height: 60px;
        font-size: 1.6rem;
        bottom: 20px;
        right: 20px;
      }
      
      .locations-list ul {
        max-height: 160px;
      }
    }

    .leaflet-control-layers {
      border-radius: 10px !important;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
      border: 1px solid #dee2e6 !important;
    }

    .leaflet-control-layers-list {
      padding: 0.8rem !important;
    }

    .leaflet-control-layers label {
      padding: 0.6rem 0.8rem !important;
      margin: 0 !important;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      transition: background-color 0.2s;
      border-radius: 6px;
    }

    .leaflet-control-layers label:hover {
      background-color: #f8f9fa;
    }

    .leaflet-control-layers input {
      margin-right: 0.8rem !important;
      accent-color: #1a237e;
    }

    .leaflet-popup-content {
      font-size: 0.95rem !important;
      padding: 0.8rem !important;
    }

    .leaflet-popup-content strong {
      color: #1a237e;
      margin-bottom: 0.5rem;
      display: block;
    }

    .custom-marker {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .info-panel {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e9ecef;
    }

    .info-panel p {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.8rem;
      line-height: 1.5;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .info-panel i {
      color: #1a237e;
      margin-top: 0.2rem;
      flex-shrink: 0;
    }

    .backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    @media (max-width: 767px) {
      .backdrop.active {
        display: block;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>LASU Campus Navigation Map</h1>
    <p>Interactive map of Lagos State University. Find key locations, navigate between buildings, and explore campus facilities.</p>
    <span class="lasu-badge">STUDENT NAVIGATION TOOL</span>
  </header>

  <div class="container">
    <div id="map"></div>

    <aside class="sidebar" id="sidebar">
      <h2><i class="fas fa-map-marker-alt"></i> Campus Navigator</h2>

      <div class="controls">
        <button class="btn" onclick="locateUser()">
          <i class="fas fa-location-crosshairs"></i> Show My Location
        </button>
        
        <div class="status-box" id="statusBox">
          Tap any location to view details and get navigation directions.
        </div>

        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" id="searchInput" placeholder="Search for buildings, halls, or facilities..." onfocus="onSearchFocus()">
        </div>
      </div>

      <div class="locations-list">
        <h3><i class="fas fa-building"></i> Campus Locations</h3>
        <ul id="locationsList">
          <!-- List will be generated dynamically -->
        </ul>
      </div>

      <div class="info-panel">
        <p><i class="fas fa-info-circle"></i> <strong>Tip:</strong> Tap any location marker on the map or in the list to view details.</p>
        <p><i class="fas fa-map-signs"></i> <strong>Navigation:</strong> Use "Show My Location" then tap "Navigate" in any location popup.</p>
        <p><i class="fas fa-mobile-alt"></i> <strong>Mobile:</strong> Swipe up from bottom to open this panel anytime.</p>
      </div>
    </aside>
  </div>

  <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>

  <button class="mobile-nav-toggle" id="mobileToggle" aria-label="Toggle navigation panel">
    <i class="fas fa-map" id="toggleIcon"></i>
  </button>

  <footer class="footer">
    <p>LASU Campus Navigation Map &copy; 2024 | Lagos State University | 
       <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors | 
       Powered by <a href="https://leafletjs.com/" target="_blank">Leaflet</a>
    </p>
    <p style="margin-top:0.5rem; font-size:0.75rem; opacity:0.7;">Student navigation tool for Lagos State University campus exploration.</p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Campus locations with corrected coordinates
    const locations = [
      // Commercial/Student Hub
      { id: "arcade", name: "Arcade (Student Commercial Hub)", coords: [6.465718, 3.203115] },

      // Lecture Halls and Auditoriums
      { id: "main_auditorium", name: "Main Auditorium", coords: [6.473108, 3.201887] },
      { id: "mass_comm_hall", name: "Mass Communication Hall", coords: [6.472277, 3.200154] },
      { id: "economics_hall", name: "Economics Lecture Hall", coords: [6.475243, 3.199060] },

      // Libraries (Essential for students)
      { id: "library", name: "Main Library", coords: [6.464857, 3.200701] },
      { id: "science_library", name: "Science Library", coords: [6.464526, 3.199186] },
      { id: "law_library", name: "Law Library", coords: [6.464095, 3.200192] },

      // ICT and Exam Centers
      { id: "cbt_center", name: "CBT Center (Exam Hall)", coords: [6.475192, 3.201302] },
      { id: "ict", name: "ICT Building", coords: [6.468753, 3.201230] },

      // Student Services
      { id: "health", name: "Health Center", coords: [6.465443, 3.202018] },
      { id: "sports", name: "Sports Center", coords: [6.469750, 3.202550] },

      // Faculty Buildings (Departmental Halls)
      { id: "education", name: "Faculty of Education", coords: [6.472996, 3.199889] },
      { id: "arts", name: "Faculty of Arts", coords: [6.464550, 3.201790] },
      { id: "law", name: "Faculty of Law", coords: [6.467085, 3.202029] },
      { id: "management_sciences", name: "Faculty of Management Sciences", coords: [6.475661, 3.199942] },
      { id: "sciences", name: "Faculty of Sciences", coords: [6.466275, 3.200283] },
      { id: "social_sciences", name: "Faculty of Social Sciences", coords: [6.475243, 3.199060] },

      // Specialized Schools
      { id: "school_of_transport", name: "School of Transport & Logistics", coords: [6.474193, 3.198038] },
      { id: "post_graduate_school", name: "Post Graduate School", coords: [6.468391, 3.201227] },

      // Banking (Essential for students)
      { id: "bank_arena", name: "Bank Arena", coords: [6.464388, 3.204019] },

      // Religious (Frequently visited)
      { id: "mosque", name: "LASU Central Mosque", coords: [6.465425, 3.200015] },

      // Transportation
      { id: "lasu_shuttle_park", name: "LASU Shuttle Park", coords: [6.475243, 3.199060] }
    ];

    const lasuCenter = [6.4700, 3.2000];
    const map = L.map("map", {
      maxZoom: 21,
      zoomControl: true,
      tap: true,
      touchZoom: true,
      dragging: true,
      scrollWheelZoom: true,
      zoomSnap: 0.5,
      zoomDelta: 0.5
    }).setView(lasuCenter, 15.5);

    // Map layers
    const streetLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19
    });

    const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: '© Esri, Maxar, Earthstar Geographics',
      maxZoom: 20
    });

    const terrainLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}", {
      attribution: '© Esri, DeLorme, NAVTEQ',
      maxZoom: 19
    });

    const baseLayers = {
      "Satellite View": satelliteLayer,
      "Street Map": streetLayer,
      "Terrain Map": terrainLayer
    };

    satelliteLayer.addTo(map);

    L.control.layers(baseLayers, null, {
      position: 'topright',
      collapsed: true
    }).addTo(map);

    // UI Elements
    const statusBox = document.getElementById("statusBox");
    const locationsList = document.getElementById("locationsList");
    const markers = {};
    let userLocationMarker = null;
    let userLatLng = null;
    let navigationLine = null;
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileToggle');
    const toggleIcon = document.getElementById('toggleIcon');
    const backdrop = document.getElementById('backdrop');

    // Toggle sidebar for mobile
    function toggleSidebar() {
      sidebar.classList.toggle('active');
      backdrop.classList.toggle('active');
      
      if (sidebar.classList.contains('active')) {
        toggleIcon.className = 'fas fa-times';
        mobileToggle.style.background = 'linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%)';
      } else {
        toggleIcon.className = 'fas fa-map';
        mobileToggle.style.background = 'linear-gradient(135deg, #1a237e 0%, #283593 100%)';
      }
    }

    function closeSidebarOnMobile() {
      if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
        toggleSidebar();
      }
    }

    function onSearchFocus() {
      if (window.innerWidth < 768) {
        if (!sidebar.classList.contains('active')) {
          toggleSidebar();
        }
      }
    }

    mobileToggle.addEventListener('click', toggleSidebar);
    backdrop.addEventListener('click', toggleSidebar);

    // Calculate distance between two points
    function getDistanceInMeters(latLng1, latLng2) {
      return latLng1.distanceTo(latLng2);
    }

    // Get marker color based on category
    function getMarkerColor(category) {
      const colors = {
        'faculty': '#3498db',
        'department': '#9b59b6',
        'lecture': '#1abc9c',
        'administrative': '#f39c12',
        'healthcare': '#e74c3c',
        'religious': '#2c3e50',
        'ict': '#16a085',
        'bank': '#27ae60',
        'sports': '#c0392b',
        'commercial': '#8e44ad',
        'utility': '#7f8c8d',
        'general': '#2ecc71'
      };
      return colors[category] || colors.general;
    }

    // Categorize locations
    function getCategoryFromLocation(location) {
      const name = location.name.toLowerCase();
      
      if (name.includes('arcade') || name.includes('commercial')) return 'commercial';
      if (name.includes('mosque')) return 'religious';
      if (name.includes('bank')) return 'bank';
      if (name.includes('sport')) return 'sports';
      if (name.includes('shuttle')) return 'utility';
      if (name.includes('ict') || name.includes('cbt') || name.includes('computer')) return 'ict';
      if (name.includes('medical') || name.includes('health')) return 'healthcare';
      if (name.includes('faculty') || name.includes('school')) return 'faculty';
      if (name.includes('library') || name.includes('lab')) return 'department';
      if (name.includes('lecture') || name.includes('hall') || name.includes('auditorium')) return 'lecture';
      return 'general';
    }

    // Populate sidebar with locations
    function populateSidebar() {
      locationsList.innerHTML = '';
      locations.forEach(location => {
        const li = document.createElement('li');
        li.setAttribute('data-location-id', location.id);
        li.innerHTML = `
          <div class="location-marker" style="background-color: ${getMarkerColor(getCategoryFromLocation(location))}"></div>
          <div class="location-name">${location.name}</div>
        `;
        li.onclick = () => {
          focusOnMarker(location.id);
          closeSidebarOnMobile();
        };
        locationsList.appendChild(li);
      });
    }

    // Create navigation line between two points
    function createNavigationLine(fromLatLng, toLatLng) {
      if (navigationLine) {
        map.removeLayer(navigationLine);
      }
      
      navigationLine = L.polyline([fromLatLng, toLatLng], {
        color: '#1a237e',
        weight: 4,
        opacity: 0.8,
        dashArray: '10, 5',
        className: 'nav-line'
      }).addTo(map);
      
      const distance = getDistanceInMeters(fromLatLng, toLatLng);
      navigationLine.bindTooltip(`Distance: ${Math.round(distance)} meters`, {
        permanent: false,
        direction: 'top',
        className: 'nav-tooltip'
      });
      
      return navigationLine;
    }

    // Initialize markers on the map
    function initializeMarkers() {
      locations.forEach(location => {
        const category = getCategoryFromLocation(location);
        const markerColor = getMarkerColor(category);
        
        // Create custom marker icon
        const markerIcon = L.divIcon({
          className: 'custom-marker',
          html: `
            <div style="
              background-color: ${markerColor};
              width: 20px;
              height: 20px;
              border-radius: 50%;
              border: 3px solid white;
              box-shadow: 0 3px 10px rgba(0,0,0,0.3);
              position: relative;
            ">
              <div style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 8px;
                height: 8px;
                background-color: white;
                border-radius: 50%;
              "></div>
            </div>`,
          iconSize: [26, 26],
          iconAnchor: [13, 13]
        });
        
        // Create non-draggable marker
        const marker = L.marker(location.coords, { 
          draggable: false, // Disabled dragging
          title: location.name,
          icon: markerIcon
        }).addTo(map);
        
        // Create popup content
        const popupContent = `
          <div style="padding: 0.5rem;">
            <strong style="color: #1a237e; font-size: 1.1rem; display: block; margin-bottom: 0.8rem;">${location.name}</strong>
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
              <div style="width: 12px; height: 12px; background-color: ${markerColor}; border-radius: 50%; margin-right: 0.5rem;"></div>
              <span style="color: #666; font-size: 0.9rem;">${category.charAt(0).toUpperCase() + category.slice(1)}</span>
            </div>
            <button class="nav-btn" onclick="navigateToMarker('${location.id}');" style="width: 100%; text-align: center; padding: 0.8rem; margin-top: 0.8rem;">
              <i class="fas fa-directions" style="margin-right: 0.5rem;"></i>Navigate from my location
            </button>
          </div>`;
        
        marker.bindPopup(popupContent);
        marker.locationData = location;
        
        // Marker click event
        marker.on("click", () => {
          statusBox.textContent = `${location.name} selected`;
          closeSidebarOnMobile();
        });

        markers[location.id] = marker;
      });
    }

    // Focus on a specific marker
    function focusOnMarker(locationId) {
      const marker = markers[locationId];
      const location = locations.find(loc => loc.id === locationId);
      
      if (marker && location) {
        map.setView(marker.getLatLng(), 17);
        marker.openPopup();
        statusBox.textContent = `Viewing: ${location.name}`;
      }
    }

    // Find nearest building to user
    function findNearestBuilding(userLatLng) {
      let nearestDistance = Infinity;
      let nearestLocation = null;
      
      locations.forEach(location => {
        const marker = markers[location.id];
        if (marker) {
          const markerLatLng = marker.getLatLng();
          const distance = getDistanceInMeters(userLatLng, markerLatLng);
          
          if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestLocation = location;
          }
        }
      });
      
      return { location: nearestLocation, distance: nearestDistance };
    }

    // Navigate to a marker from user's location
    function navigateToMarker(locationId) {
      if (!userLatLng) {
        alert("Please enable location services and click 'Show My Location' first.");
        return;
      }
      
      const marker = markers[locationId];
      if (marker) {
        const markerLatLng = marker.getLatLng();
        createNavigationLine(userLatLng, markerLatLng);
        marker.openPopup();
        statusBox.textContent = `Navigating to ${marker.locationData.name}`;
      }
    }

    // Locate user
    function locateUser() {
      if (!navigator.geolocation) {
        statusBox.textContent = "Geolocation is not supported by your browser";
        return;
      }
      
      statusBox.textContent = "Locating your position...";
      
      navigator.geolocation.getCurrentPosition(
        position => {
          const userCoords = [
            position.coords.latitude,
            position.coords.longitude
          ];
          
          userLatLng = L.latLng(userCoords[0], userCoords[1]);
          const lasuCenterLatLng = L.latLng(lasuCenter[0], lasuCenter[1]);
          const distanceFromCampus = getDistanceInMeters(userLatLng, lasuCenterLatLng);
          
          if (distanceFromCampus > 2000) {
            statusBox.textContent = "You appear to be outside LASU campus. Showing campus center.";
            map.setView(lasuCenter, 15.5);
            return;
          }

          // Remove existing user marker
          if (userLocationMarker) {
            map.removeLayer(userLocationMarker);
          }

          // Create pulsing user location marker
          userLocationMarker = L.marker(userCoords, { 
            icon: L.divIcon({
              className: 'leaflet-pulsing-icon',
              iconSize: [32, 32],
              iconAnchor: [16, 16]
            })
          })
            .addTo(map)
            .bindPopup("You are here")
            .openPopup();

          // Center map on user
          map.setView(userCoords, 17);
          
          // Find nearest building
          const nearest = findNearestBuilding(userLatLng);
          if (nearest.location) {
            statusBox.textContent = `You're near ${nearest.location.name} (${Math.round(nearest.distance)}m away)`;
            markers[nearest.location.id].openPopup();
          }
          
          closeSidebarOnMobile();
        }, 
        error => {
          statusBox.textContent = "Location access denied or unavailable. Please enable location services.";
        }, 
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    }

    // Search locations
    function searchLocations() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const listItems = document.querySelectorAll('#locationsList li');
      let firstMatch = null;
      let matchCount = 0;
      
      listItems.forEach(item => {
        const locationId = item.getAttribute('data-location-id');
        const location = locations.find(loc => loc.id === locationId);
        const name = location.name.toLowerCase();
        
        if (searchTerm === '' || name.includes(searchTerm)) {
          item.style.display = 'flex';
          matchCount++;
          if (!firstMatch) firstMatch = locationId;
        } else {
          item.style.display = 'none';
        }
      });
      
      if (searchTerm.length > 0) {
        if (firstMatch) {
          focusOnMarker(firstMatch);
          statusBox.textContent = `Found ${matchCount} location(s) matching "${searchTerm}"`;
        } else {
          statusBox.textContent = `No locations found matching "${searchTerm}"`;
        }
      } else {
        statusBox.textContent = "Tap any location to view details and get navigation directions.";
      }
    }

    // Initialize everything
    document.getElementById('searchInput').addEventListener('input', searchLocations);
    
    // Close sidebar when clicking on map
    map.on('click', function() {
      closeSidebarOnMobile();
    });

    // Initialize
    populateSidebar();
    initializeMarkers();

    // Mobile responsiveness
    if (window.innerWidth < 768) {
      sidebar.classList.remove('active');
      mobileToggle.style.display = 'flex';
    }

    window.addEventListener('resize', function() {
      if (window.innerWidth >= 768) {
        sidebar.classList.remove('active');
        backdrop.classList.remove('active');
        mobileToggle.style.display = 'none';
        toggleIcon.className = 'fas fa-map';
        mobileToggle.style.background = 'linear-gradient(135deg, #1a237e 0%, #283593 100%)';
      } else {
        mobileToggle.style.display = 'flex';
      }
    });

    // Add smooth scroll behavior for mobile
    document.addEventListener('touchmove', function(e) {
      if (sidebar.classList.contains('active')) {
        e.stopPropagation();
      }
    }, { passive: false });
  </script>
</body>
</html>
