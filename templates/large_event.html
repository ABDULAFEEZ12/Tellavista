<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nelavista Smart Classroom</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        /* [Keep ALL your existing CSS styles - they're good] */
        /* Only adding critical WebRTC debugging styles below */
        
        .webrtc-debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-width: 300px;
            max-height: 200px;
            overflow: auto;
            display: none;
        }
        
        .webrtc-debug.active {
            display: block;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #000;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 10000;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- [Keep ALL your existing HTML structure] -->
    
    <!-- Add WebRTC Debug Panel -->
    <div class="webrtc-debug" id="webrtcDebug">
        <div><strong>WebRTC Debug</strong></div>
        <div id="debugLog"></div>
    </div>
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>

    <script>
        // ============================================
        // WebRTC DEBUG FUNCTIONS
        // ============================================
        function logDebug(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML = `[${timestamp}] ${message}<br>` + debugLog.innerHTML;
            console.log(`[DEBUG] ${message}`);
            
            // Keep only last 20 messages
            const lines = debugLog.innerHTML.split('<br>');
            if (lines.length > 20) {
                debugLog.innerHTML = lines.slice(0, 20).join('<br>');
            }
        }
        
        function toggleDebug() {
            document.getElementById('webrtcDebug').classList.toggle('active');
        }
        
        // ============================================
        // Updated WebRTC Configuration for Render.com
        // ============================================
        const config = {
            roomId: '{{ room_id }}',
            username: '{{ username }}',
            role: '{{ role }}',
            // Enhanced WebRTC config for production
            rtcConfig: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                    // Note: For production, add TURN servers here
                    // { urls: 'turn:your-turn-server.com:3478', username: 'user', credential: 'pass' }
                ],
                iceTransportPolicy: 'all',
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require',
                iceCandidatePoolSize: 10
            }
        };
        
        // ============================================
        // CRITICAL FIX: Student WebRTC Offer Handling
        // ============================================
        async function acceptTeacherOffer(data) {
            logDebug(`Student: Received offer from ${data.from_sid}`);
            
            try {
                // CRITICAL: Verify this is from our teacher
                if (!state.teacherSid) {
                    logDebug(`Student: No teacher SID set yet`);
                    // Set it from the offer
                    state.teacherSid = data.from_sid;
                    logDebug(`Student: Setting teacher SID to ${data.from_sid}`);
                }
                
                if (data.from_sid !== state.teacherSid) {
                    logDebug(`Student: Ignoring offer from non-teacher ${data.from_sid}`);
                    return;
                }
                
                logDebug(`Student: Creating RTCPeerConnection for teacher ${data.from_sid}`);
                
                // Create peer connection with better error handling
                const pc = new RTCPeerConnection(config.rtcConfig);
                
                // Handle incoming stream from teacher
                pc.ontrack = (event) => {
                    logDebug(`Student: Received ${event.track.kind} track from teacher`);
                    
                    if (event.streams && event.streams[0]) {
                        logDebug(`Student: Setting teacher video stream (${event.streams[0].id})`);
                        
                        const teacherVideo = document.getElementById('teacherVideo');
                        teacherVideo.srcObject = event.streams[0];
                        
                        const noStream = document.getElementById('noStream');
                        if (noStream) noStream.style.display = 'none';
                        
                        // Try to play the video
                        teacherVideo.play().catch(e => {
                            logDebug(`Student: Auto-play blocked: ${e.message}`);
                            // Show play button overlay
                            showToast('info', 'Video Ready', 'Click the video to start playback');
                        });
                    }
                };
                
                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        logDebug(`Student: Sending ICE candidate to teacher`);
                        state.socket.emit('webrtc-ice-candidate', {
                            room: state.roomId,
                            target_sid: data.from_sid,
                            candidate: event.candidate
                        });
                    } else {
                        logDebug(`Student: ICE gathering complete`);
                    }
                };
                
                // Monitor connection state
                pc.onconnectionstatechange = () => {
                    logDebug(`Student: Connection state: ${pc.connectionState}`);
                    
                    if (pc.connectionState === 'connected') {
                        logDebug(`Student: SUCCESS - Connected to teacher!`);
                        showToast('success', 'Connected', 'Teacher video stream is now live');
                    }
                    
                    if (pc.connectionState === 'failed') {
                        logDebug(`Student: Connection failed, trying to reconnect...`);
                        // Try to reconnect after 2 seconds
                        setTimeout(() => {
                            if (pc.connectionState === 'failed') {
                                acceptTeacherOffer(data);
                            }
                        }, 2000);
                    }
                };
                
                // Set the remote description (teacher's offer)
                logDebug(`Student: Setting remote description`);
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                // Create answer
                logDebug(`Student: Creating answer`);
                const answer = await pc.createAnswer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                logDebug(`Student: Setting local description`);
                await pc.setLocalDescription(answer);
                
                // Send answer back to teacher
                logDebug(`Student: Sending answer to teacher`);
                state.socket.emit('webrtc-answer', {
                    room: state.roomId,
                    target_sid: data.from_sid,
                    answer: pc.localDescription
                });
                
                // Store the connection
                state.peerConnections.set(data.from_sid, pc);
                logDebug(`Student: Offer accepted successfully`);
                
            } catch (error) {
                logDebug(`Student: ERROR accepting offer: ${error.message}`);
                console.error('Student WebRTC error:', error);
                showToast('error', 'Connection Error', `Failed to connect: ${error.message}`);
            }
        }
        
        // ============================================
        // CRITICAL FIX: Teacher WebRTC Setup
        // ============================================
        async function startTeacherBroadcast() {
            logDebug(`Teacher: Starting broadcast...`);
            showLoading('Starting broadcast...');
            
            try {
                // Get teacher's camera and microphone
                const constraints = {
                    video: {
                        width: { ideal: 640, max: 1280 },  // Lower for better performance
                        height: { ideal: 480, max: 720 },
                        frameRate: { ideal: 20, max: 24 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };
                
                logDebug(`Teacher: Requesting media with constraints`);
                state.teacherStream = await navigator.mediaDevices.getUserMedia(constraints);
                logDebug(`Teacher: Got media stream with ${state.teacherStream.getTracks().length} tracks`);
                
                // Show teacher their own video IMMEDIATELY
                const teacherVideo = document.getElementById('teacherVideo');
                teacherVideo.srcObject = state.teacherStream;
                
                const noStream = document.getElementById('noStream');
                if (noStream) noStream.style.display = 'none';
                
                // Play the video
                teacherVideo.play().catch(e => {
                    logDebug(`Teacher: Auto-play blocked: ${e.message}`);
                });
                
                // Create connections for all existing students
                const studentSids = Array.from(state.participants.entries())
                    .filter(([sid, data]) => data.role === 'student')
                    .map(([sid, data]) => sid);
                
                logDebug(`Teacher: Creating connections for ${studentSids.length} students`);
                
                for (const studentSid of studentSids) {
                    await createTeacherToStudentConnection(studentSid);
                }
                
                // Update UI
                state.isBroadcasting = true;
                const liveBadge = document.getElementById('liveBadge');
                if (liveBadge) liveBadge.classList.add('active');
                
                const startBtn = document.getElementById('startBroadcastBtn');
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i><span>Broadcasting</span>';
                }
                
                logDebug(`Teacher: Broadcast started successfully`);
                hideLoading();
                showToast('success', 'Broadcast Started', 'Students can now see your video');
                
            } catch (error) {
                logDebug(`Teacher: ERROR starting broadcast: ${error.message}`);
                console.error('Teacher broadcast error:', error);
                showToast('error', 'Camera Error', `Please allow camera access: ${error.message}`);
                hideLoading();
            }
        }
        
        async function createTeacherToStudentConnection(studentSid) {
            logDebug(`Teacher: Creating connection for student ${studentSid}`);
            
            try {
                // Don't create duplicate connections
                if (state.peerConnections.has(studentSid)) {
                    logDebug(`Teacher: Already have connection for ${studentSid}`);
                    return;
                }
                
                // Create peer connection
                const pc = new RTCPeerConnection(config.rtcConfig);
                
                // Add teacher's tracks to the connection
                if (state.teacherStream) {
                    state.teacherStream.getTracks().forEach(track => {
                        pc.addTrack(track, state.teacherStream);
                    });
                    logDebug(`Teacher: Added ${state.teacherStream.getTracks().length} tracks to connection`);
                }
                
                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        logDebug(`Teacher: Sending ICE candidate to student ${studentSid}`);
                        state.socket.emit('webrtc-ice-candidate', {
                            room: state.roomId,
                            target_sid: studentSid,
                            candidate: event.candidate
                        });
                    }
                };
                
                // Listen for answer from student
                pc.oniceconnectionstatechange = () => {
                    logDebug(`Teacher: ICE connection state for ${studentSid}: ${pc.iceConnectionState}`);
                };
                
                // Create and send offer
                logDebug(`Teacher: Creating offer for student ${studentSid}`);
                const offer = await pc.createOffer({
                    offerToReceiveAudio: false,
                    offerToReceiveVideo: false
                });
                
                logDebug(`Teacher: Setting local description`);
                await pc.setLocalDescription(offer);
                
                logDebug(`Teacher: Sending offer to student ${studentSid}`);
                state.socket.emit('webrtc-offer', {
                    room: state.roomId,
                    target_sid: studentSid,
                    offer: pc.localDescription
                });
                
                // Store connection
                state.peerConnections.set(studentSid, pc);
                logDebug(`Teacher: Connection created for student ${studentSid}`);
                
            } catch (error) {
                logDebug(`Teacher: ERROR creating connection for ${studentSid}: ${error.message}`);
                console.error('Teacher connection error:', error);
            }
        }
        
        // ============================================
        // CRITICAL FIX: Handle WebRTC Answers (Teacher side)
        // ============================================
        function handleWebRTCAnswer(data) {
            logDebug(`Teacher: Received answer from ${data.from_sid}`);
            
            const pc = state.peerConnections.get(data.from_sid);
            if (pc && pc.signalingState !== 'closed') {
                pc.setRemoteDescription(new RTCSessionDescription(data.answer))
                    .then(() => {
                        logDebug(`Teacher: Successfully set remote description from ${data.from_sid}`);
                    })
                    .catch(err => {
                        logDebug(`Teacher: ERROR setting remote description: ${err.message}`);
                    });
            } else {
                logDebug(`Teacher: No active connection for ${data.from_sid}`);
            }
        }
        
        // ============================================
        // Socket.IO Event Listeners - UPDATED
        // ============================================
        function initializeSocket() {
            logDebug('Initializing Socket.IO connection...');
            
            state.socket = io({
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 1000,
                transports: ['websocket', 'polling'],
                timeout: 20000
            });
            
            // BASIC CONNECTION EVENTS
            state.socket.on('connect', () => {
                logDebug(`Connected! Socket ID: ${state.socket.id}`);
                state.sid = state.socket.id;
                joinRoom();
            });
            
            state.socket.on('disconnect', (reason) => {
                logDebug(`Disconnected: ${reason}`);
            });
            
            // ROOM EVENTS
            state.socket.on('room-joined', (data) => {
                logDebug(`Joined room ${data.room} as ${data.role}`);
                state.teacherSid = data.teacher_sid;
                if (data.role === 'student' && data.teacher_sid) {
                    logDebug(`Teacher is in room: ${data.teacher_sid}`);
                    showToast('info', 'Teacher Connected', 'Waiting for video stream...');
                }
            });
            
            state.socket.on('teacher-joined', (data) => {
                logDebug(`Teacher joined: ${data.teacher_name} (${data.teacher_sid})`);
                state.teacherSid = data.teacher_sid;
            });
            
            state.socket.on('teacher-disconnected', () => {
                logDebug('Teacher disconnected');
                state.teacherSid = null;
                const teacherVideo = document.getElementById('teacherVideo');
                if (teacherVideo) teacherVideo.srcObject = null;
            });
            
            // CRITICAL: WebRTC Events
            state.socket.on('webrtc-offer', (data) => {
                logDebug(`Received WebRTC offer from ${data.from_sid}`);
                if (state.role === 'student') {
                    acceptTeacherOffer(data);
                }
            });
            
            state.socket.on('webrtc-answer', (data) => {
                logDebug(`Received WebRTC answer from ${data.from_sid}`);
                if (state.role === 'teacher') {
                    handleWebRTCAnswer(data);
                }
            });
            
            state.socket.on('webrtc-ice-candidate', (data) => {
                logDebug(`Received ICE candidate from ${data.from_sid}`);
                const pc = state.peerConnections.get(data.from_sid);
                if (pc && pc.remoteDescription && data.candidate) {
                    pc.addIceCandidate(new RTCIceCandidate(data.candidate))
                        .catch(err => logDebug(`ERROR adding ICE candidate: ${err.message}`));
                }
            });
            
            // Broadcast event
            state.socket.on('start-broadcast', () => {
                logDebug('Teacher started broadcast');
                if (state.role === 'student') {
                    showToast('info', 'Teacher is Broadcasting', 'Video stream should start soon...');
                }
            });
        }
        
        // ============================================
        // Initialize the app
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            logDebug('Page loaded, initializing...');
            
            // Auto-enable debug on mobile
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                document.getElementById('webrtcDebug').classList.add('active');
                logDebug('Mobile device detected');
            }
            
            // Force username (from your requirement)
            if (!config.username || config.username.trim() === '') {
                alert('Please enter your name to join the classroom');
                window.location.href = '/large_event/join?room=' + encodeURIComponent(config.roomId);
                return;
            }
            
            // Initialize Socket.IO
            initializeSocket();
        });
        
        // ============================================
        // Make functions globally available
        // ============================================
        window.startBroadcast = startTeacherBroadcast;
        window.toggleDebug = toggleDebug;
        window.acceptTeacherOffer = acceptTeacherOffer;
        
        // Toast function (simplified)
        function showToast(type, title, message) {
            console.log(`[TOAST] ${title}: ${message}`);
            // Your existing toast implementation
        }
        
        function showLoading(message) {
            console.log(`[LOADING] ${message}`);
            // Your existing loading implementation
        }
        
        function hideLoading() {
            // Your existing hide loading implementation
        }
        
        // ============================================
        // Global state object
        // ============================================
        const state = {
            socket: null,
            roomId: config.roomId,
            username: config.username,
            role: config.role,
            sid: null,
            teacherSid: null,
            isBroadcasting: false,
            peerConnections: new Map(),
            teacherStream: null,
            participants: new Map()
        };
    </script>
</body>
</html>
