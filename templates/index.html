<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VBZ3H70FTN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-VBZ3H70FTN');
  </script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nelavista - AI Educational Companion</title>

<!-- MathJax for LaTeX rendering in chat -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
/* ===== CSS VARIABLES & RESET ===== */
:root {
  --primary-color: #000000;
  --primary-dark: #333333;
  --light-bg: #ffffff;
  --dark-bg: #000000;
  --card-light: #ffffff;
  --card-dark: #0a0a0a;
  --text-light: #000000;
  --text-dark: #ffffff;
  --sidebar-dark: #000000;
  --overlay-dark: rgba(0, 0, 0, 0.7);
  --user-msg-bg: #1a1a1a;
  --ai-msg-bg: #0a0a0a;
  --input-bg: #0a0a0a;
  --gradient-start: #ffffff;
  --gradient-end: #888888;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

body {
  background: var(--dark-bg);
  color: var(--text-dark);
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
  overflow-x: hidden;
}

body.light-mode {
  background: var(--light-bg);
  color: var(--text-light);
}

/* ===== TOP BAR (Updated with proper z-index) ===== */
#top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 1002;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

body.light-mode #top-bar {
  background: rgba(255, 255, 255, 0.95);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

#menu-toggle,
#theme-toggle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  transition: background 0.2s;
}

body.light-mode #menu-toggle,
body.light-mode #theme-toggle {
  background: rgba(0, 0, 0, 0.05);
  color: #000;
}

#menu-toggle:hover,
#theme-toggle:hover {
  background: rgba(255, 255, 255, 0.2);
}

body.light-mode #menu-toggle:hover,
body.light-mode #theme-toggle:hover {
  background: rgba(0, 0, 0, 0.1);
}

/* ===== SIDEBAR MENU ===== */
#side-menu {
  position: fixed;
  top: 0;
  left: -260px;
  width: 260px;
  height: 100%;
  background: var(--sidebar-dark);
  transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1003;
  overflow-y: auto;
  padding-top: 70px;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
}

#side-menu.active {
  left: 0;
}

#side-menu ul {
  list-style: none;
}

#side-menu li {
  padding: 0;
}

#side-menu a {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  color: var(--text-dark);
  text-decoration: none;
  font-size: 15px;
  transition: background 0.2s;
  border-left: 1px solid transparent;
}

#side-menu a:hover {
  background: rgba(255, 255, 255, 0.1);
  border-left-color: rgba(255, 255, 255, 0.5);
}

#side-menu a::before {
  content: '';
  display: inline-block;
  margin-right: 12px;
  font-size: 18px;
}

/* Icon mapping for menu items */
#side-menu a[href*="profile"]::before { content: 'üë§'; }
#side-menu a[href*="talk"]::before { content: 'ü§ñ'; }
#side-menu a[href*="live"]::before { content: 'üì°'; }
#side-menu a[href*="campus-map"]::before { content: 'üó∫Ô∏è'; }
#side-menu a[href*="materials"]::before { content: 'üìö'; }
#side-menu a[href*="analyze"]::before { content: 'üìä'; }
#side-menu a[href*="reels"]::before { content: 'üé¨'; }
#side-menu a[href*="CBT"]::before { content: 'üìù'; }
#side-menu a[href*="about"]::before { content: '‚ÑπÔ∏è'; }
#side-menu a[href*="settings"]::before { content: '‚öôÔ∏è'; }
#side-menu a[href*="privacy"]::before { content: 'üîí'; }
#side-menu a[href*="logout"]::before { content: 'üö™'; }

/* ===== OVERLAY ===== */
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--overlay-dark);
  display: none;
  z-index: 1002;
  backdrop-filter: blur(2px);
  cursor: pointer;
}

#overlay.active {
  display: block;
}

/* ===== LANDING/HOME SCREEN ===== */
.logo-section {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px 100px;
  transition: opacity 0.3s ease, transform 0.3s ease;
  z-index: 1;
}

.logo-section.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateY(-20px);
}

.logo {
  font-size: 3rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
  text-align: center;
}

.tagline {
  color: #a0a0a0;
  margin-bottom: 2.5rem;
  text-align: center;
  font-size: 1.2rem;
  max-width: 500px;
  line-height: 1.5;
}

body.light-mode .tagline {
  color: #666;
}

.chips-container {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  max-width: 600px;
  margin: 0 auto;
  animation: fadeInUp 0.8s ease 0.3s both;
}

.chip {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 24px;
  padding: 14px 22px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--text-dark);
  user-select: none;
}

body.light-mode .chip {
  background: rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0, 0, 0, 0.1);
  color: var(--text-light);
}

.chip:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
}

body.light-mode .chip:hover {
  background: rgba(0, 0, 0, 0.1);
}

.chip::before {
  margin-right: 8px;
}

/* ===== CHAT CONTAINER ===== */
.chat-container {
  display: none;
  flex-direction: column;
  height: calc(100vh - 60px);
  margin-top: 60px;
  position: relative;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
  width: 100%;
  opacity: 0;
  animation: fadeIn 0.5s ease 0.1s forwards;
}

.chat-container.active {
  display: flex;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  padding-bottom: 100px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

/* Message animation - Very gentle fade in with slight upward movement */
@keyframes messageAppear {
  from {
    opacity: 0;
    transform: translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message {
  margin: 16px 0;
  animation: messageAppear 0.5s ease-out;
  display: block;
  position: relative;
  will-change: transform, opacity;
}

.message-content {
  display: inline-block;
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 18px;
  line-height: 1.5;
  word-wrap: break-word;
  position: relative;
  transition: transform 0.2s ease;
}

.message.user .message-content {
  background: var(--user-msg-bg);
  border-bottom-right-radius: 4px;
  margin-left: auto;
  float: right;
  clear: both;
}

.message.ai .message-content {
  background: var(--ai-msg-bg);
  border-bottom-left-radius: 4px;
  float: left;
  clear: both;
}

body.light-mode .message.user .message-content {
  background: #000000;
  color: white;
}

body.light-mode .message.ai .message-content {
  background: #f0f0f0;
  color: #000;
}

/* Clear floats after messages */
.message::after {
  content: "";
  display: table;
  clear: both;
}

/* ===== INPUT AREA ===== */
.input-area {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 16px 20px 20px;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 1001;
  transition: transform 0.3s ease;
}

body.light-mode .input-area {
  background: rgba(255, 255, 255, 0.95);
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.input-wrapper {
  max-width: 800px;
  margin: 0 auto;
  background: var(--input-bg);
  border-radius: 24px;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  transition: all 0.3s ease;
  border: 1px solid transparent;
  will-change: transform;
}

body.light-mode .input-wrapper {
  background: #ffffff;
  border: 1px solid #ddd;
}

.input-wrapper:focus-within {
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

body.light-mode .input-wrapper:focus-within {
  border-color: rgba(0, 0, 0, 0.3);
}

.input-wrapper input {
  flex: 1;
  background: none;
  border: none;
  color: white;
  padding: 10px 16px;
  outline: none;
  font-size: 15px;
  transition: opacity 0.3s ease;
}

body.light-mode .input-wrapper input {
  color: #000;
}

.input-wrapper input::placeholder {
  color: #999;
  transition: opacity 0.3s ease;
}

body.light-mode .input-wrapper input::placeholder {
  color: #666;
}

.attachment-icon,
.voice-icon {
  background: none;
  border: none;
  color: #999;
  font-size: 18px;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
  margin: 0 4px;
  opacity: 0.7;
}

.attachment-icon:hover,
.voice-icon:hover {
  opacity: 1;
  transform: scale(1.1);
}

.send-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: var(--primary-color);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.3s ease;
  margin-left: 8px;
  opacity: 0.8;
}

.send-btn:hover {
  opacity: 1;
  transform: scale(1.05);
}

.send-btn:active {
  transform: scale(0.95);
}

.send-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

/* ===== ATTACHMENT PREVIEW ===== */
.attachment-container {
  max-width: 800px;
  margin: 0 auto 10px;
  padding: 10px 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  animation: fadeIn 0.3s ease;
}

.attachment-preview {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  font-size: 12px;
  animation: fadeIn 0.3s ease;
}

.attachment-remove {
  background: none;
  border: none;
  color: #ffffff;
  cursor: pointer;
  padding: 2px;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.attachment-remove:hover {
  opacity: 1;
}

/* ===== TYPING INDICATOR ===== */
.typing-indicator {
  display: inline-block;
  padding: 12px 16px;
  margin: 16px 0;
  background: var(--ai-msg-bg);
  border-radius: 18px;
  border-bottom-left-radius: 4px;
  float: left;
  clear: both;
  animation: fadeIn 0.3s ease;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
  opacity: 0.3;
  animation: typingPulse 1.8s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: 0s; }
.typing-dots span:nth-child(2) { animation-delay: 0.3s; }
.typing-dots span:nth-child(3) { animation-delay: 0.6s; }

@keyframes typingPulse {
  0%, 100% { 
    opacity: 0.3;
    transform: scale(0.9);
  }
  50% { 
    opacity: 0.8;
    transform: scale(1);
  }
}

body.light-mode .typing-indicator {
  background: #f0f0f0;
}

body.light-mode .typing-dots span {
  background: #000000;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
  transition: background 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.2);
}

body.light-mode ::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.1);
}

body.light-mode ::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.2);
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
  .logo {
    font-size: 2.5rem;
  }
  
  .tagline {
    font-size: 1.1rem;
    padding: 0 20px;
  }
  
  .chips-container {
    gap: 10px;
    padding: 0 20px;
  }
  
  .chip {
    padding: 12px 18px;
    font-size: 0.9rem;
  }
  
  .message-content {
    max-width: 90%;
  }
  
  #side-menu {
    width: 260px;
  }
  
  .chat-container {
    padding: 0 16px;
  }
  
  .messages {
    padding: 16px 0 100px;
  }
  
  .input-area {
    padding: 12px 16px 20px;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  .input-wrapper {
    padding: 6px 10px;
  }
  
  /* Mobile keyboard handling */
  @media (max-height: 500px) {
    .input-area {
      padding: 8px 12px 12px;
    }
  }
}

@media (max-width: 480px) {
  .logo {
    font-size: 2rem;
  }
  
  .chips-container {
    flex-direction: column;
    align-items: center;
  }
  
  .chip {
    width: 100%;
    max-width: 280px;
    justify-content: center;
  }
  
  .input-area {
    padding: 12px 12px 20px;
  }
  
  .input-wrapper {
    padding: 6px 10px;
  }
  
  .input-wrapper input {
    padding: 8px 12px;
    font-size: 14px;
  }
  
  .send-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  .message-content {
    max-width: 95%;
  }
}

/* ===== UTILITY CLASSES ===== */
.hidden {
  display: none !important;
}

.show {
  display: block !important;
}

.flex-show {
  display: flex !important;
}
</style>
</head>
<body class="dark-mode">

<!-- TOP BAR -->
<div id="top-bar">
  <button id="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
  <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
</div>

<!-- SIDEBAR -->
<div id="side-menu">
  <ul>
    <li><a href="/profile">Profile</a></li>
    <li><a href="/talk-to-nelavista">Talk to Nelavista</a></li>
    <li><a href="/analyze">Analyze Materials</a></li>
    <li><a href="/live-meeting">Live Meeting</a></li>
    <li><a href="/materials">Study Materials</a></li>
    <li><a href="/mat101">Math 101 Videos</a></li>
    <li><a href="/reels">Reels</a></li>
    <li><a href="/CBT">CBT Test</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/campus-map">Lasu Map</a></li>
    <li><a href="/settings">Settings</a></li>
    <li><a href="/privacy-policy">Privacy Policy</a></li>
    <li><a href="/logout">Logout</a></li>
  </ul>
</div>

<!-- OVERLAY for closing menu -->
<div id="overlay" onclick="closeMenu()"></div>

<!-- LANDING/HOME SCREEN -->
<div class="logo-section" id="logoSection">
  <div class="logo">Nelavista</div>
  <div class="tagline">How can I help you with your studies?</div>
  
  <div class="chips-container">
    <div class="chip" onclick="handleChipClick('ai')">Study with AI</div>
    <div class="chip" onclick="window.location.href='/analyze'">Analyze Materials</div>
    <div class="chip" onclick="handleChipClick('materials')">Materials</div>
    <div class="chip" onclick="handleChipClick('cbt')">Practice CBT</div>
  </div>
</div>

<!-- CHAT CONTAINER -->
<div class="chat-container" id="chatContainer">
  <div class="messages" id="messages">
    <!-- Messages will be inserted here -->
  </div>
  
  <!-- Attachment preview area -->
  <div class="attachment-container" id="attachmentContainer" style="display: none;"></div>
</div>

<!-- INPUT AREA -->
<div class="input-area">
  <div class="input-wrapper">
    <button class="attachment-icon" onclick="document.getElementById('fileInput').click()">üìé</button>
    <input type="file" id="fileInput" style="display: none;" accept=".pdf,.png,.jpg,.jpeg,.gif" onchange="handleFileSelect(this.files)" multiple>
    
    <button class="voice-icon" onclick="toggleVoiceInput()">üé§</button>
    
    <input 
      type="text" 
      id="chatInput" 
      placeholder="Ask anything about your studies..."
      onkeypress="handleKeyPress(event)"
    />
    
    <button class="send-btn" id="sendButton" onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script>
// ===== GLOBAL STATE =====
const state = {
  isChatMode: false,
  messages: [],
  pendingAttachments: [],
  isRecording: false,
  recognition: null,
  theme: localStorage.getItem('theme') || 'dark',
  isLoading: false
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
  initializeTheme();
  addWelcomeMessage();
  setupEventListeners();
  
  // Enhance scroll performance
  enhanceScrollPerformance();
});

function enhanceScrollPerformance() {
  const messagesDiv = document.getElementById('messages');
  if (messagesDiv) {
    messagesDiv.style.backfaceVisibility = 'hidden';
    messagesDiv.style.perspective = '1000px';
  }
}

function initializeTheme() {
  if (state.theme === 'dark') {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').textContent = 'üåô';
  } else {
    document.body.classList.add('light-mode');
    document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
  }
}

function addWelcomeMessage() {
  if (!state.isChatMode) {
    setTimeout(() => {
      if (state.messages.length === 0) {
        // Display welcome message WITHOUT any labels
        addMessage("üëã Welcome to Nelavista! I'm your AI educational companion. Ask me anything about your studies, or try one of the quick actions above.", 'ai');
      }
    }, 800); // Slightly delayed for better animation flow
  }
}

function setupEventListeners() {
  const chatInput = document.getElementById('chatInput');
  
  // Add focus listener for chat input
  chatInput.addEventListener('focus', () => {
    if (!state.isChatMode) {
      enterChatMode();
    }
  });
  
  chatInput.addEventListener('input', updateSendButton);
  
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Mobile keyboard handling
  window.addEventListener('resize', handleMobileLayout);
  handleMobileLayout();
}

function handleMobileLayout() {
  const isMobile = window.innerWidth <= 768;
  const inputArea = document.querySelector('.input-area');
  
  if (isMobile) {
    // Force hardware acceleration for mobile
    inputArea.style.transform = 'translateZ(0)';
    inputArea.style.webkitTransform = 'translateZ(0)';
  }
}

// ===== THEME TOGGLE =====
function toggleTheme() {
  const themeBtn = document.getElementById('theme-toggle');
  
  if (document.body.classList.contains('dark-mode')) {
    document.body.classList.remove('dark-mode');
    document.body.classList.add('light-mode');
    themeBtn.textContent = '‚òÄÔ∏è';
    state.theme = 'light';
  } else {
    document.body.classList.remove('light-mode');
    document.body.classList.add('dark-mode');
    themeBtn.textContent = 'üåô';
    state.theme = 'dark';
  }
  
  localStorage.setItem('theme', state.theme);
}

// ===== SIDEBAR MENU FUNCTIONS =====
function toggleMenu() {
  const sideMenu = document.getElementById('side-menu');
  const overlay = document.getElementById('overlay');
  
  sideMenu.classList.toggle('active');
  overlay.classList.toggle('active');
  
  if (sideMenu.classList.contains('active')) {
    document.body.style.overflow = 'hidden';
  } else {
    document.body.style.overflow = '';
  }
}

function closeMenu() {
  document.getElementById('side-menu').classList.remove('active');
  document.getElementById('overlay').classList.remove('active');
  document.body.style.overflow = '';
}

// ===== CHIP CLICK HANDLER =====
function handleChipClick(type) {
  // Special case for Campus Map - perform full page navigation
  if (type === '/campus-map') {
    window.location.href = '/campus-map';
    return;
  }
  
  const chipActions = {
    'ai': () => {
      // Enter chat mode first, then set placeholder
      enterChatMode();
      const suggestions = [
        "Explain quantum physics in simple terms",
        "Help me solve this math problem: 2x + 5 = 15",
        "What are the best study techniques for exams?",
        "Can you help me understand photosynthesis?"
      ];
      const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
      const input = document.getElementById('chatInput');
      input.placeholder = `Try: "${randomSuggestion}"`;
      
      // Gentle animation for placeholder change
      input.style.opacity = '0.7';
      setTimeout(() => {
        input.style.opacity = '1';
      }, 300);
    },
    'materials': () => window.location.href = '/materials',
    'cbt': () => window.location.href = '/CBT',
    'live': () => window.location.href = '/live-meeting',
    'reels': () => window.location.href = '/reels'
  };
  
  if (chipActions[type]) {
    // Add gentle animation to clicked chip
    event.target.style.transform = 'scale(0.98)';
    setTimeout(() => {
      event.target.style.transform = '';
    }, 150);
    
    chipActions[type]();
  }
}

// ===== CHAT MODE TRANSITION =====
function enterChatMode() {
  if (!state.isChatMode) {
    state.isChatMode = true;
    
    // Immediately hide the landing section
    const logoSection = document.getElementById('logoSection');
    logoSection.style.opacity = '0';
    logoSection.style.pointerEvents = 'none';
    logoSection.style.transform = 'translateY(-20px)';
    
    // Show chat container
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.classList.add('active');
    
    // Scroll to bottom and focus input
    setTimeout(() => {
      const messagesDiv = document.getElementById('messages');
      if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
      document.getElementById('chatInput').focus();
    }, 50);
    
    // Smooth scroll to bottom on mobile
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }, 300);
    }
    
    // Prevent logo section from being visible again
    setTimeout(() => {
      logoSection.style.display = 'none';
    }, 500);
  }
}

// ===== MESSAGE HANDLING =====
function addMessage(text, sender = 'user') {
  const messagesDiv = document.getElementById('messages');
  
  // Remove typing indicator if present
  const typingIndicator = messagesDiv.querySelector('.typing-indicator');
  if (typingIndicator) {
    typingIndicator.style.opacity = '0';
    setTimeout(() => {
      if (typingIndicator.parentNode) {
        typingIndicator.remove();
      }
    }, 300);
  }
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'message-content';
  
  // Preserve line breaks in text
  contentDiv.innerHTML = text.replace(/\n/g, '<br>');
  
  messageDiv.appendChild(contentDiv);
  messagesDiv.appendChild(messageDiv);
  
  // Store message
  state.messages.push({ text, sender, timestamp: Date.now() });
  
  // Auto-scroll to bottom with smooth behavior
  setTimeout(() => {
    messagesDiv.scrollTo({
      top: messagesDiv.scrollHeight,
      behavior: 'smooth'
    });
  }, 50);
  
  // Render LaTeX in the new message
  renderMathInElement(messageDiv);
}

// ===== MathJax LaTeX RENDERING =====
function renderMathInElement(element) {
  if (window.MathJax && MathJax.typesetPromise) {
    MathJax.typesetPromise([element]).catch(err => console.error('MathJax typeset error:', err));
  } else {
    // If MathJax isn't loaded, wait and try again
    setTimeout(() => {
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise([element]).catch(err => console.error('MathJax typeset error:', err));
      }
    }, 100);
  }
}

function showTypingIndicator() {
  const messagesDiv = document.getElementById('messages');
  
  // Remove any existing typing indicator with fade out
  const existingIndicator = messagesDiv.querySelector('.typing-indicator');
  if (existingIndicator) {
    existingIndicator.style.opacity = '0';
    setTimeout(() => {
      if (existingIndicator.parentNode) {
        existingIndicator.remove();
      }
    }, 300);
  }
  
  // Add new typing indicator with fade in
  setTimeout(() => {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.style.opacity = '0';
    
    const dotsDiv = document.createElement('div');
    dotsDiv.className = 'typing-dots';
    dotsDiv.innerHTML = '<span></span><span></span><span></span>';
    
    typingDiv.appendChild(dotsDiv);
    messagesDiv.appendChild(typingDiv);
    
    // Fade in animation
    setTimeout(() => {
      typingDiv.style.opacity = '1';
    }, 10);
    
    // Auto-scroll to show typing indicator
    messagesDiv.scrollTo({
      top: messagesDiv.scrollHeight,
      behavior: 'smooth'
    });
  }, 300);
  
  state.isLoading = true;
}

// ===== BACKEND API COMMUNICATION =====
async function sendToBackend(message, attachments = []) {
  try {
    const formData = new FormData();
    formData.append('message', message);
    
    attachments.forEach(attachment => {
      formData.append('files', attachment.file);
    });
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to backend endpoint
    const response = await fetch('/ask_with_files', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Remove typing indicator with fade out
    const messagesDiv = document.getElementById('messages');
    const typingIndicator = messagesDiv.querySelector('.typing-indicator');
    if (typingIndicator) {
      typingIndicator.style.opacity = '0';
      setTimeout(() => {
        if (typingIndicator.parentNode) {
          typingIndicator.remove();
        }
      }, 300);
    }
    
    state.isLoading = false;
    
    // Add AI response to chat
    if (data.answer) {
      addMessage(data.answer, 'ai');
    } else {
      addMessage("I received your message but couldn't generate a response. Please try again.", 'ai');
    }
    
    return data;
  } catch (error) {
    console.error('Error sending to backend:', error);
    
    // Remove typing indicator
    const messagesDiv = document.getElementById('messages');
    const typingIndicator = messagesDiv.querySelector('.typing-indicator');
    if (typingIndicator) {
      typingIndicator.style.opacity = '0';
      setTimeout(() => {
        if (typingIndicator.parentNode) {
          typingIndicator.remove();
        }
      }, 300);
    }
    
    state.isLoading = false;
    
    // Show error message
    addMessage("Sorry, I encountered an error while processing your request. Please try again.", 'ai');
    
    throw error;
  }
}

// ===== INPUT HANDLING =====
function handleKeyPress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
}

function updateSendButton() {
  const input = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendButton');
  sendBtn.disabled = input.value.trim() === '' && state.pendingAttachments.length === 0;
}

async function sendMessage() {
  if (state.isLoading) {
    return;
  }
  
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  
  if (text === '' && state.pendingAttachments.length === 0) {
    return;
  }
  
  // Enter chat mode if not already
  if (!state.isChatMode) {
    enterChatMode();
  }
  
  // Add user message to chat immediately
  if (text) {
    addMessage(text, 'user');
  }
  
  // Handle attachments in user message
  let attachmentMessage = '';
  const attachmentsToSend = [...state.pendingAttachments];
  
  if (attachmentsToSend.length > 0) {
    attachmentMessage = `üìé Sent ${attachmentsToSend.length} file${attachmentsToSend.length > 1 ? 's' : ''}: ${attachmentsToSend.map(f => f.name).join(', ')}`;
    addMessage(attachmentMessage, 'user');
  }
  
  // Clear input and attachments preview with animation
  input.value = '';
  input.style.opacity = '0.7';
  setTimeout(() => {
    input.style.opacity = '1';
  }, 150);
  
  updateSendButton();
  
  // Send to backend
  try {
    await sendToBackend(text, attachmentsToSend);
    
    // Clear attachments after successful backend response
    state.pendingAttachments = [];
    const attachmentContainer = document.getElementById('attachmentContainer');
    attachmentContainer.style.opacity = '0';
    setTimeout(() => {
      attachmentContainer.style.display = 'none';
      attachmentContainer.style.opacity = '1';
    }, 300);
  } catch (error) {
    console.error('Failed to send message:', error);
  }
  
  // Focus input for next message
  setTimeout(() => {
    input.focus();
  }, 100);
}

// ===== FILE ATTACHMENTS =====
function handleFileSelect(files) {
  if (!files || files.length === 0) return;
  
  const file = files[0];
  const maxSize = 16 * 1024 * 1024;
  
  if (file.size > maxSize) {
    alert(`File too large (${(file.size/1024/1024).toFixed(1)}MB). Maximum size is 16MB.`);
    return;
  }
  
  const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'application/pdf'];
  if (!allowedTypes.includes(file.type)) {
    alert('Please upload only PDF or image files (PNG, JPG, GIF).');
    return;
  }
  
  state.pendingAttachments.push({
    id: 'att_' + Date.now(),
    file,
    name: file.name,
    size: file.size,
    type: file.type
  });
  
  renderAttachmentPreview();
  
  if (!state.isChatMode) {
    enterChatMode();
  }
  
  const container = document.getElementById('attachmentContainer');
  container.style.display = 'flex';
  container.style.opacity = '0';
  setTimeout(() => {
    container.style.opacity = '1';
  }, 10);
  
  updateSendButton();
}

function renderAttachmentPreview() {
  const container = document.getElementById('attachmentContainer');
  container.innerHTML = '';
  
  state.pendingAttachments.forEach(attachment => {
    const preview = document.createElement('div');
    preview.className = 'attachment-preview';
    preview.dataset.id = attachment.id;
    preview.style.opacity = '0';
    
    const icon = attachment.type === 'application/pdf' ? 'üìÑ' : 'üñºÔ∏è';
    const size = formatFileSize(attachment.size);
    
    preview.innerHTML = `
      <span>${icon}</span>
      <span>${attachment.name}</span>
      <span style="opacity: 0.7; font-size: 11px;">(${size})</span>
      <button class="attachment-remove" onclick="removeAttachment('${attachment.id}')">‚úï</button>
    `;
    
    container.appendChild(preview);
    
    // Fade in animation
    setTimeout(() => {
      preview.style.opacity = '1';
    }, 10);
  });
}

function removeAttachment(attachmentId) {
  const attachmentIndex = state.pendingAttachments.findIndex(a => a.id === attachmentId);
  if (attachmentIndex > -1) {
    const preview = document.querySelector(`[data-id="${attachmentId}"]`);
    if (preview) {
      preview.style.opacity = '0';
      preview.style.transform = 'translateX(-10px)';
      setTimeout(() => {
        state.pendingAttachments.splice(attachmentIndex, 1);
        
        if (state.pendingAttachments.length > 0) {
          renderAttachmentPreview();
        } else {
          const container = document.getElementById('attachmentContainer');
          container.style.opacity = '0';
          setTimeout(() => {
            container.style.display = 'none';
          }, 300);
        }
        
        updateSendButton();
      }, 300);
    }
  }
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// ===== VOICE INPUT =====
function toggleVoiceInput() {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert('Voice input is not supported in your browser. Try Chrome or Edge.');
    return;
  }
  
  const voiceBtn = document.querySelector('.voice-icon');
  
  if (!state.isRecording) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    state.recognition = new SpeechRecognition();
    state.recognition.lang = 'en-US';
    state.recognition.interimResults = false;
    state.recognition.maxAlternatives = 1;
    
    state.recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      const input = document.getElementById('chatInput');
      input.value = transcript;
      input.style.opacity = '0.7';
      setTimeout(() => {
        input.style.opacity = '1';
      }, 150);
      voiceBtn.style.opacity = '0.7';
      setTimeout(() => {
        voiceBtn.style.opacity = '1';
      }, 300);
      state.isRecording = false;
      updateSendButton();
    };
    
    state.recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      voiceBtn.style.opacity = '0.7';
      setTimeout(() => {
        voiceBtn.style.opacity = '1';
      }, 300);
      state.isRecording = false;
    };
    
    state.recognition.onend = () => {
      voiceBtn.style.opacity = '0.7';
      setTimeout(() => {
        voiceBtn.style.opacity = '1';
      }, 300);
      state.isRecording = false;
    };
    
    state.recognition.start();
    voiceBtn.style.opacity = '0.5';
    state.isRecording = true;
  } else {
    if (state.recognition) {
      state.recognition.stop();
    }
    voiceBtn.style.opacity = '0.7';
    setTimeout(() => {
      voiceBtn.style.opacity = '1';
    }, 300);
    state.isRecording = false;
  }
}

// ===== PERSISTENCE =====
function saveChatHistory() {
  if (state.messages.length > 0) {
    localStorage.setItem('nelavista_chat_history', JSON.stringify(state.messages));
  }
}

function loadChatHistory() {
  try {
    const saved = localStorage.getItem('nelavista_chat_history');
    if (saved) {
      const history = JSON.parse(saved);
      const recentMessages = history.slice(-20);
      recentMessages.forEach((msg, index) => {
        if (msg.text && msg.sender) {
          // Stagger the loading of history messages
          setTimeout(() => {
            addMessage(msg.text, msg.sender);
          }, index * 100);
        }
      });
    }
  } catch (e) {
    console.error('Failed to load chat history:', e);
  }
}

// Save before page unload
window.addEventListener('beforeunload', saveChatHistory);

// Load on start if in chat mode
if (window.location.hash === '#chat') {
  setTimeout(() => {
    enterChatMode();
    loadChatHistory();
  }, 300);
}
</script>
</body>
</html>
